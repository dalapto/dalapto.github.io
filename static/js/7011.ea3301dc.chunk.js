"use strict";(self.webpackChunkreact_arcgis=self.webpackChunkreact_arcgis||[]).push([[7011],{27011:function(e,t,r){r.d(t,{q:function(){return ye}});var n=r(93433),i=r(29439),a=r(1413),s=r(37762),u=r(74165),o=r(15861),c=r(43144),l=r(15671),f=r(63780),h=r(10064),p=r(84652),d=r(92026),y=r(18759),v=r(66978),m=r(68860),x=r(41414),g=r(65156),Z=r(376),_=r(77981),b=r(91340),k=r(92975),F=r(83406),w=r(43404),S=r(16054),I=r(48562),R=function(){function e(t,r){(0,l.Z)(this,e),this._cache=new S.z(t),this._invalidCache=new S.z(r)}return(0,c.Z)(e,[{key:"get",value:function(e,t){var r="".concat(t.uid,":").concat(e),n=this._cache.get(r);if(n)return n;if(void 0!==this._invalidCache.get(r))return null;try{var i=I.WhereClause.create(e,t);return this._cache.put(r,i),i}catch(a){return this._invalidCache.put(r,null),null}}}]),e}(),T=new R(50,500),A="feature-store:unsupported-query",V=" as ",Q=new w.X({esriFieldTypeString:"string"}),C=new w.X({esriFieldTypeOID:"oid",esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long"}),E=new w.X({esriFieldTypeDate:"date"}),z=new w.X({esriFieldTypeGUID:"guid",esriFieldTypeGlobalId:"global-id"}),q=new Set([].concat((0,n.Z)(C.jsonValues),(0,n.Z)(E.jsonValues),(0,n.Z)(Q.jsonValues),(0,n.Z)(z.jsonValues))),D=new Intl.ListFormat("en-US",{type:"conjunction"}).format([].concat((0,n.Z)(C.apiValues),(0,n.Z)(E.apiValues),(0,n.Z)(Q.apiValues),(0,n.Z)(z.apiValues)));function M(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=G(e,t);if(!n)throw new h.Z(A,"invalid SQL expression",{expression:e});var i=r.expressionName||"expression";if(r.validateStandardized&&!n.isStandardized)throw new h.Z(A,"".concat(i," is not standard"),{expression:e});if(r.validateAggregate&&!n.isAggregate)throw new h.Z(A,"".concat(i," does not contain a valid aggregate function"),{expression:e});return n.fieldNames}function P(e,t,r,n){if(!t)return!0;var i="having",a=M(t,e,{validateAggregate:!0,expressionName:i});N(e,a,{expressionName:i,query:n}),O(e,a,{expressionName:i,query:n});var s=T.get(t,e),u=null===s||void 0===s?void 0:s.getExpressions().every((function(t){var n,i=t.aggregateType,a=t.field,s=null===(n=e.get(a))||void 0===n?void 0:n.name;return r.some((function(t){var r,n=t.onStatisticField,a=t.statisticType;return(null===(r=e.get(n))||void 0===r?void 0:r.name)===s&&a.toLowerCase().trim()===i}))}));if(!u)throw new h.Z(A,"expressions in having should also exist in outStatistics",{having:t});return!0}function G(e,t){return e?T.get(e,t):null}function N(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r.errorMessage||(r.errorMessage=r.expressionName?"".concat(r.expressionName," contains invalid fields"):"Fields are invalid"),j(e,t,(function(e,t){return t.has(e)}),r)}function O(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r.errorMessage||(r.errorMessage=r.expressionName?"".concat(r.expressionName," only supports ").concat(D," field types"):"Only ".concat(D," field types are supported")),j(e,t,(function(e,t){return!L(e,t)}),r)}function j(e,t,r){var i,a,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=null===(i=u.verifyExpression)||void 0===i||i,c=[],l=(0,s.Z)(t);try{for(l.s();!(a=l.n()).done;){var f=a.value,p=r(f,e);if("*"!==f&&!p)if(o){var d=B(f);try{j(e,M(d,e,{validateStandardized:!0}),r,u)}catch(E){var y=null===E||void 0===E?void 0:E.details;if(null!==y&&void 0!==y&&y.expression)throw E;null!==y&&void 0!==y&&y.invalidFields?c.push.apply(c,(0,n.Z)(y.invalidFields)):c.push(f)}}else c.push(f)}}catch(v){l.e(v)}finally{l.f()}if(c.length)throw new h.Z(A,u.errorMessage,{invalidFields:c,query:u.query})}function B(e){return e.split(V)[0]}function L(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q,n=t.get(e);return!!n&&!r.has(n.type)}var H=r(19995),U=r(60480),Y=r(4954),W=r(94446),X=r(58971),J=r(31904),$=r(71486),K=r(819),ee=function(){function e(t,r,n){var i;(0,l.Z)(this,e),this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=null!==(i=t.returnDistinctValues)&&void 0!==i&&i,this.fieldsIndex=n,this.featureAdapter=r;var a=t.outFields;if(a&&!a.includes("*")){this.outFields=a;var u,o=0,c=(0,s.Z)(a);try{for(c.s();!(u=c.n()).done;){var f=u.value,h=B(f),p=this.fieldsIndex.get(h),d=p?null:G(h,n),y=p?p.name:f.split(V)[1]||"FIELD_EXP_"+o++;this._fieldDataCache.set(f,{alias:y,clause:d})}}catch(v){c.e(v)}finally{c.f()}}}return(0,c.Z)(e,[{key:"countDistinctValues",value:function(e){var t=this;return this.returnDistinctValues?(e.forEach((function(e){return t.getAttributes(e)})),this._returnDistinctMap.size):e.length}},{key:"getAttributes",value:function(e){var t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}},{key:"getFieldValue",value:function(e,t,r){var n,i,a=r?r.name:t,s=null;return this._fieldDataCache.has(a)?s=null===(n=this._fieldDataCache.get(a))||void 0===n?void 0:n.clause:r||(s=G(t,this.fieldsIndex),this._fieldDataCache.set(a,{alias:a,clause:s})),r?this.featureAdapter.getAttribute(e,a):null===(i=s)||void 0===i?void 0:i.calculateValue(e,this.featureAdapter)}},{key:"getDataValues",value:function(e,t){var r=this,n=t.normalizationType,i=t.normalizationTotal;return e.map((function(e){var a=t.field&&r.getFieldValue(e,t.field,r.fieldsIndex.get(t.field));if(t.field2&&(a="".concat((0,$.wk)(a)).concat(t.fieldDelimiter).concat((0,$.wk)(r.getFieldValue(e,t.field2,r.fieldsIndex.get(t.field2)))),t.field3&&(a="".concat(a).concat(t.fieldDelimiter).concat((0,$.wk)(r.getFieldValue(e,t.field3,r.fieldsIndex.get(t.field3)))))),n&&Number.isFinite(a)){var s="field"===n&&t.normalizationField?r.getFieldValue(e,t.normalizationField,r.fieldsIndex.get(t.normalizationField)):null;a=(0,$.fk)(a,n,s,i)}return a}))}},{key:"getExpressionValues",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r,n,i){var s,o,c,l,f,h,p=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,K.LC)();case 2:if(s=e.sent,o=s.arcadeUtils,c=o.hasGeometryOperations(r),e.t0=c,!e.t0){e.next=9;break}return e.next=9,o.enableGeometryOperations();case 9:return l=o.createFunction(r),f=n&&o.getViewInfo(n),h={fields:this.fieldsIndex.fields},e.abrupt("return",t.map((function(e){var t={attributes:p.featureAdapter.getAttributes(e),layer:h,geometry:c?(0,a.Z)((0,a.Z)({},(0,J.Op)(i.geometryType,i.hasZ,i.hasM,p.featureAdapter.getGeometry(e))),{},{spatialReference:null===n||void 0===n?void 0:n.spatialReference}):null},r=o.createExecContext(t,f);return o.executeFunction(l,r)})));case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"validateItem",value:function(e,t){var r,n;return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:G(t,this.fieldsIndex)}),null!==(r=null===(n=this._fieldDataCache.get(t))||void 0===n||null===(n=n.clause)||void 0===n?void 0:n.testFeature(e,this.featureAdapter))&&void 0!==r&&r}},{key:"validateItems",value:function(e,t){var r,n;return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:G(t,this.fieldsIndex)}),null!==(r=null===(n=this._fieldDataCache.get(t))||void 0===n||null===(n=n.clause)||void 0===n?void 0:n.testSet(e,this.featureAdapter))&&void 0!==r&&r}},{key:"_processAttributesForOutFields",value:function(e){var t=this.outFields;if(!t||!t.length)return this.featureAdapter.getAttributes(e);var r,n={},i=(0,s.Z)(t);try{for(i.s();!(r=i.n()).done;){var a=r.value,u=this._fieldDataCache.get(a),o=u.alias,c=u.clause;n[o]=c?c.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,o)}}catch(l){i.e(l)}finally{i.f()}return n}},{key:"_processAttributesForDistinctValues",value:function(e){if(null==e||!this.returnDistinctValues)return e;var t=this.outFields,r=[];if(t){var n,i=(0,s.Z)(t);try{for(i.s();!(n=i.n()).done;){var a=n.value,u=this._fieldDataCache.get(a).alias;r.push(e[u])}}catch(f){i.e(f)}finally{i.f()}}else for(var o in e)r.push(e[o]);var c="".concat((t||["*"]).join(","),"=").concat(r.join(",")),l=this._returnDistinctMap.get(c)||0;return this._returnDistinctMap.set(c,++l),l>1?null:e}}]),e}();function te(e,t,r){return{objectId:e,target:t,distance:r,type:"vertex"}}function re(e,t,r,n,i){return{objectId:e,target:t,distance:r,type:"edge",start:n,end:i,draped:arguments.length>5&&void 0!==arguments[5]&&arguments[5]}}var ne=r(37270),ie=function(){function e(t,r,n){(0,l.Z)(this,e),this.items=t,this.query=r,this.geometryType=n.geometryType,this.hasM=n.hasM,this.hasZ=n.hasZ,this.fieldsIndex=n.fieldsIndex,this.objectIdField=n.objectIdField,this.spatialReference=n.spatialReference,this.featureAdapter=n.featureAdapter}return(0,c.Z)(e,[{key:"size",get:function(){return this.items.length}},{key:"createQueryResponseForCount",value:function(){var e=new ee(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);var t=this.query,r=t.groupByFieldsForStatistics,n=t.having,i=t.outStatistics;if(!(null===r||void 0===r?void 0:r.length))return 1;var a,u=new Map,o=new Map,c=new Set,l=(0,s.Z)(i);try{for(l.s();!(a=l.n()).done;){var f=a.value,h="exceedslimit"!==f.statisticType?f.onStatisticField:void 0;if(!o.has(h)){var p,d=[],y=(0,s.Z)(r);try{for(y.s();!(p=y.n()).done;){var v=p.value,m=this._getAttributeValues(e,v,u);d.push(m)}}catch(F){y.e(F)}finally{y.f()}o.set(h,this._calculateUniqueValues(d,e.returnDistinctValues))}var x=o.get(h);for(var g in x){var Z=x[g],_=Z.data,b=Z.items,k=_.join(",");n&&!e.validateItems(b,n)||c.add(k)}}}catch(F){l.e(F)}finally{l.f()}return c.size}},{key:"createQueryResponse",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.query.outStatistics){e.next=11;break}if(!this.query.outStatistics.some((function(e){return"exceedslimit"===e.statisticType}))){e.next=5;break}e.t0=this._createExceedsLimitQueryResponse(this.query),e.next=8;break;case 5:return e.next=7,this._createStatisticsQueryResponse(this.query);case 7:e.t0=e.sent;case 8:t=e.t0,e.next=12;break;case 11:t=this._createFeatureQueryResponse(this.query);case 12:return this.query.returnQueryGeometry&&(r=this.query.geometry,(0,k.JY)(this.query.outSR)&&!(0,k.fS)(r.spatialReference,this.query.outSR)?t.queryGeometry=(0,J.S2)((0,a.Z)({spatialReference:this.query.outSR},(0,H.iV)(r,r.spatialReference,this.query.outSR))):t.queryGeometry=(0,J.S2)((0,a.Z)({spatialReference:this.query.outSR},r))),e.abrupt("return",t);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"createSnappingResponse",value:function(e,t){var r,n=this.featureAdapter,i=se(this.hasZ,this.hasM),a=e.point,u=e.mode,o="number"==typeof e.distance?e.distance:e.distance.x,c="number"==typeof e.distance?e.distance:e.distance.y,l={candidates:[]},f="esriGeometryPolygon"===this.geometryType,h=this._getPointCreator(u,this.spatialReference,t),p=new ue(null,0),d=new ue(null,0),y={x:0,y:0,z:0},v=(0,s.Z)(this.items);try{for(v.s();!(r=v.n()).done;){var m=r.value,x=n.getGeometry(m);if(null!=x){var g=x.coords,Z=x.lengths;if(p.coords=g,d.coords=g,e.returnEdge)for(var _=0,b=0;b<Z.length;b++)for(var k=Z[b],F=0;F<k;F++,_+=i){var w=p;if(w.coordsIndex=_,F!==k-1){var S=d;S.coordsIndex=_+i;var I=y;ae(y,a,w,S);var R=(a.x-I.x)/o,T=(a.y-I.y)/c,A=R*R+T*T;A<=1&&l.candidates.push(re(n.getObjectId(m),h(I),Math.sqrt(A),h(w),h(S)))}}if(e.returnVertex)for(var V=f?g.length-i:g.length,Q=0;Q<V;Q+=i){var C=p;C.coordsIndex=Q;var E=(a.x-C.x)/o,z=(a.y-C.y)/c,q=E*E+z*z;q<=1&&l.candidates.push(te(n.getObjectId(m),h(C),Math.sqrt(q)))}}}}catch(D){v.e(D)}finally{v.f()}return l.candidates.sort((function(e,t){return e.distance-t.distance})),l}},{key:"_getPointCreator",value:function(e,t,r){var n=null==r||(0,k.fS)(t,r)?function(e){return e}:function(e){return(0,H.iV)(e,t,r)},i=this.hasZ;return"3d"===e?i?function(e){var t=e.x,r=e.y,i=e.z;return n({x:t,y:r,z:i})}:function(e){var t=e.x,r=e.y;return n({x:t,y:r,z:0})}:function(e){var t=e.x,r=e.y;return n({x:t,y:r})}}},{key:"createSummaryStatisticsResponse",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i,a,s,o,c,l,f,h,p,d,y,v;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,i=t.normalizationField,a=t.normalizationType,s=t.normalizationTotal,o=t.minValue,c=t.maxValue,l=t.scale,f=this.fieldsIndex.isDateField(r),e.next=11,this._getDataValues({field:r,valueExpression:n,normalizationField:i,normalizationType:a,normalizationTotal:s,scale:l});case 11:return h=e.sent,p=(0,$.S5)({normalizationType:a,normalizationField:i,minValue:o,maxValue:c}),d=this.fieldsIndex.get(r),y={value:.5,fieldType:null===d||void 0===d?void 0:d.type},v=(0,ne.qN)(d)?(0,$.H0)({values:h,supportsNullCount:p,percentileParams:y}):(0,$.i5)({values:h,minValue:o,maxValue:c,useSampleStdDev:!a,supportsNullCount:p,percentileParams:y}),e.abrupt("return",(0,$.F_)(v,f));case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createUniqueValuesResponse",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i,a,s,o,c;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,i=t.domains,a=t.returnAllCodedValues,s=t.scale,e.next=7,this._getDataValues({field:r,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,valueExpression:n,scale:s});case 7:return o=e.sent,c=(0,$.eT)(o),e.abrupt("return",(0,$.Qm)(c,i,a,t.fieldDelimiter));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createClassBreaksResponse",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i,a,s,o,c,l,f,h,p,d,y;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,i=t.normalizationField,a=t.normalizationType,s=t.normalizationTotal,o=t.classificationMethod,c=t.standardDeviationInterval,l=t.minValue,f=t.maxValue,h=t.numClasses,p=t.scale,e.next=13,this._getDataValues({field:r,valueExpression:n,normalizationField:i,normalizationType:a,normalizationTotal:s,scale:p});case 13:return d=e.sent,y=(0,$.G2)(d,{field:r,normalizationField:i,normalizationType:a,normalizationTotal:s,classificationMethod:o,standardDeviationInterval:c,minValue:l,maxValue:f,numClasses:h}),e.abrupt("return",(0,$.DL)(y,o));case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createHistogramResponse",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i,a,s,o,c,l,f,h,p,d;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,i=t.normalizationField,a=t.normalizationType,s=t.normalizationTotal,o=t.classificationMethod,c=t.standardDeviationInterval,l=t.minValue,f=t.maxValue,h=t.numBins,p=t.scale,e.next=13,this._getDataValues({field:r,valueExpression:n,normalizationField:i,normalizationType:a,normalizationTotal:s,scale:p});case 13:return d=e.sent,e.abrupt("return",(0,$.oF)(d,{field:r,normalizationField:i,normalizationType:a,normalizationTotal:s,classificationMethod:o,standardDeviationInterval:c,minValue:l,maxValue:f,numBins:h}));case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_sortFeatures",value:function(e,t,r){var n=this;if(e.length>1&&t&&t.length){var i,a=(0,s.Z)(t.reverse());try{var u=function(){var t=i.value.split(" "),a=t[0],s=n.fieldsIndex.get(a),u=!!t[1]&&"desc"===t[1].toLowerCase(),o=(0,$.Lq)(null===s||void 0===s?void 0:s.type,u);e.sort((function(e,t){var n=r(e,a,s),i=r(t,a,s);return o(n,i)}))};for(a.s();!(i=a.n()).done;)u()}catch(o){a.e(o)}finally{a.f()}}}},{key:"_createFeatureQueryResponse",value:function(e){var t=this,r=this.items,i=this.geometryType,a=this.hasM,s=this.hasZ,u=this.objectIdField,o=this.spatialReference,c=e.outFields,l=e.outSR,f=e.quantizationParameters,h=e.resultRecordCount,p=e.resultOffset,d=e.returnZ,y=e.returnM,v=null!=h&&r.length>(p||0)+h,m=c&&(c.includes("*")?(0,n.Z)(this.fieldsIndex.fields):c.map((function(e){return t.fieldsIndex.get(e)})));return{exceededTransferLimit:v,features:this._createFeatures(e,r),fields:m,geometryType:i,hasM:a&&y,hasZ:s&&d,objectIdFieldName:u,spatialReference:(0,J.S2)(l||o),transform:f&&(0,X.vY)(f)||null}}},{key:"_createFeatures",value:function(e,t){var r=new ee(e,this.featureAdapter,this.fieldsIndex),i=this.hasM,a=this.hasZ,u=e.orderByFields,o=e.quantizationParameters,c=e.returnGeometry,l=e.returnCentroid,f=e.maxAllowableOffset,h=e.resultOffset,p=e.resultRecordCount,d=e.returnZ,y=void 0!==d&&d,v=e.returnM,m=a&&y,x=i&&(void 0!==v&&v),g=[],Z=0,_=(0,n.Z)(t);if(this._sortFeatures(_,u,(function(e,t,n){return r.getFieldValue(e,t,n)})),c||l){var b,k=null!==(b=(0,X.vY)(o))&&void 0!==b?b:void 0;if(c&&!l){var F,w=(0,s.Z)(_);try{for(w.s();!(F=w.n()).done;){var S=F.value;g[Z++]={attributes:r.getAttributes(S),geometry:(0,J.Op)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(S),f,k,m,x)}}}catch(P){w.e(P)}finally{w.f()}}else if(!c&&l){var I,R=(0,s.Z)(_);try{for(R.s();!(I=R.n()).done;){var T=I.value;g[Z++]={attributes:r.getAttributes(T),centroid:(0,J.EG)(this,this.featureAdapter.getCentroid(T,this),k)}}}catch(P){R.e(P)}finally{R.f()}}else{var A,V=(0,s.Z)(_);try{for(V.s();!(A=V.n()).done;){var Q=A.value;g[Z++]={attributes:r.getAttributes(Q),centroid:(0,J.EG)(this,this.featureAdapter.getCentroid(Q,this),k),geometry:(0,J.Op)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(Q),f,k,m,x)}}}catch(P){V.e(P)}finally{V.f()}}}else{var C,E=(0,s.Z)(_);try{for(E.s();!(C=E.n()).done;){var z=C.value,q=r.getAttributes(z);q&&(g[Z++]={attributes:q})}}catch(P){E.e(P)}finally{E.f()}}var D=h||0;if(null!=p){var M=D+p;g=g.slice(D,Math.min(g.length,M))}return g}},{key:"_createExceedsLimitQueryResponse",value:function(e){var t,r,n=!1,i=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,o=(0,s.Z)(null!==(t=e.outStatistics)&&void 0!==t?t:[]);try{for(o.s();!(r=o.n()).done;){var c=r.value;if("exceedslimit"===c.statisticType){i=null!=c.maxPointCount?c.maxPointCount:Number.POSITIVE_INFINITY,a=null!=c.maxRecordCount?c.maxRecordCount:Number.POSITIVE_INFINITY,u=null!=c.maxVertexCount?c.maxVertexCount:Number.POSITIVE_INFINITY;break}}}catch(h){o.e(h)}finally{o.f()}if("esriGeometryPoint"===this.geometryType)n=this.items.length>i;else if(this.items.length>a)n=!0;else{var l=se(this.hasZ,this.hasM),f=this.featureAdapter;n=this.items.reduce((function(e,t){var r=f.getGeometry(t);return e+(null!=r&&r.coords.length||0)}),0)/l>u}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(n)}}]}}},{key:"_createStatisticsQueryResponse",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i,a,o,c,l,f,h,p,d,y,v,m,x,g,Z,_,b,k,F,w,S,I,R,T,A,V,Q,C,E,z,q,D,M,P,G,N,O=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={attributes:{}},n=[],i=new Map,a=new Map,o=new Map,c=new Map,l=new ee(t,this.featureAdapter,this.fieldsIndex),f=t.outStatistics,h=t.groupByFieldsForStatistics,p=t.having,d=t.orderByFields,y=h&&h.length,m=(v=!!y)?h[0]:null,x=v&&!this.fieldsIndex.get(m),g=(0,s.Z)(null!==f&&void 0!==f?f:[]),e.prev=2,g.s();case 4:if((Z=g.n()).done){e.next=34;break}if(_=Z.value,b=_.outStatisticFieldName,k=_.statisticType,F=_,w="exceedslimit"!==k?_.onStatisticField:void 0,S="percentile_disc"===k||"percentile_cont"===k,I="EnvelopeAggregate"===k||"CentroidAggregate"===k||"ConvexHullAggregate"===k,R=v&&1===y&&(w===m||x)&&"count"===k,!v){e.next=19;break}if(!o.has(w)){T=[],A=(0,s.Z)(h);try{for(A.s();!(V=A.n()).done;)Q=V.value,C=this._getAttributeValues(l,Q,i),T.push(C)}catch(j){A.e(j)}finally{A.f()}o.set(w,this._calculateUniqueValues(T,!I&&l.returnDistinctValues))}E=o.get(w),z=(0,u.Z)().mark((function e(){var t,r,n,a,s,o,f,d,y,v,m,x,g,Z;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=E[q],r=t.count,n=t.data,a=t.items,s=t.itemPositions,o=n.join(","),p&&!l.validateItems(a,p)){e.next=18;break}if(f=c.get(o)||{attributes:{}},!I){e.next=13;break}return f.aggregateGeometries||(f.aggregateGeometries={}),e.next=7,O._getAggregateGeometry(F,a);case 7:d=e.sent,y=d.aggregateGeometries,v=d.outStatisticFieldName,f.aggregateGeometries[v]=y,e.next=16;break;case 13:m=null,R?m=r:(x=O._getAttributeValues(l,w,i),g=s.map((function(e){return x[e]})),m=S&&"statisticParameters"in F?O._getPercentileValue(F,g):O._getStatisticValue(F,g,null,l.returnDistinctValues)),f.attributes[b]=m;case 16:Z=0,h.forEach((function(e,t){return f.attributes[O.fieldsIndex.get(e)?e:"EXPR_"+ ++Z]=n[t]})),c.set(o,f);case 18:case"end":return e.stop()}}),e)})),e.t0=(0,u.Z)().keys(E);case 12:if((e.t1=e.t0()).done){e.next=17;break}return q=e.t1.value,e.delegateYield(z(),"t2",15);case 15:e.next=12;break;case 17:e.next=31;break;case 19:if(!I){e.next=29;break}return r.aggregateGeometries||(r.aggregateGeometries={}),e.next=23,this._getAggregateGeometry(F,this.items);case 23:D=e.sent,M=D.aggregateGeometries,P=D.outStatisticFieldName,r.aggregateGeometries[P]=M,e.next=31;break;case 29:G=this._getAttributeValues(l,w,i),r.attributes[b]=S&&"statisticParameters"in F?this._getPercentileValue(F,G):this._getStatisticValue(F,G,a,l.returnDistinctValues);case 31:n.push({name:b,alias:b,type:"esriFieldTypeDouble"});case 32:e.next=4;break;case 34:e.next=39;break;case 36:e.prev=36,e.t3=e.catch(2),g.e(e.t3);case 39:return e.prev=39,g.f(),e.finish(39);case 42:return N=v?Array.from(c.values()):[r],e.abrupt("return",(this._sortFeatures(N,d,(function(e,t){return e.attributes[t]})),{fields:n,features:N}));case 44:case"end":return e.stop()}}),e,this,[[2,36,39,42]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_getAggregateGeometry",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,n){var i,s,o,c,l,f,h,p,d,y,v,m,x,g,Z;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(9058),r.e(3645)]).then(r.bind(r,50309));case 2:return i=e.sent,s=i.convexHull,o=i.union,c=t.statisticType,l=t.outStatisticFieldName,f=this.featureAdapter,h=this.spatialReference,p=this.geometryType,d=this.hasZ,y=this.hasM,v=n.map((function(e){return(0,J.Op)(p,d,y,f.getGeometry(e))})),m=s(h,v,!0)[0],x={aggregateGeometries:null,outStatisticFieldName:null},"EnvelopeAggregate"===c?(g=m?(0,W._w)(m):(0,W.aO)(o(h,v)),x.aggregateGeometries=(0,a.Z)((0,a.Z)({},g),{},{spatialReference:h}),x.outStatisticFieldName=l||"extent"):"CentroidAggregate"===c?(Z=m?(0,Y.tO)(m):(0,Y.$G)((0,W.aO)(o(h,v))),x.aggregateGeometries={x:Z[0],y:Z[1],spatialReference:h},x.outStatisticFieldName=l||"centroid"):"ConvexHullAggregate"===c&&(x.aggregateGeometries=m,x.outStatisticFieldName=l||"convexHull"),e.abrupt("return",x);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getStatisticValue",value:function(e,t,r,i){var a,s=e.onStatisticField,u=e.statisticType;return a=null!==r&&void 0!==r&&r.has(s)?r.get(s):(0,ne.qN)(this.fieldsIndex.get(s))?(0,$.H0)({values:t,returnDistinct:i}):(0,$.i5)({values:i?(0,n.Z)(new Set(t)):t,minValue:null,maxValue:null,useSampleStdDev:!0}),r&&r.set(s,a),a["var"===u?"variance":u]}},{key:"_getPercentileValue",value:function(e,t){var r=e.onStatisticField,n=e.statisticParameters,i=e.statisticType,a=n.value,s=n.orderBy,u=this.fieldsIndex.get(r);return(0,$.XL)(t,{value:a,orderBy:s,fieldType:null===u||void 0===u?void 0:u.type,isDiscrete:"percentile_disc"===i})}},{key:"_getAttributeValues",value:function(e,t,r){if(r.has(t))return r.get(t);var n=this.fieldsIndex.get(t),i=this.items.map((function(r){return e.getFieldValue(r,t,n)}));return r.set(t,i),i}},{key:"_calculateUniqueValues",value:function(e,t){for(var r={},n=this.items,i=n.length,a=0;a<i;a++){var u,o=n[a],c=[],l=(0,s.Z)(e);try{for(l.s();!(u=l.n()).done;){var f=u.value;c.push(f[a])}}catch(p){l.e(p)}finally{l.f()}var h=c.join(",");null==r[h]?r[h]={count:1,data:c,items:[o],itemPositions:[a]}:(t||r[h].count++,r[h].items.push(o),r[h].itemPositions.push(a))}return r}},{key:"_getDataValues",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new ee(this.query,this.featureAdapter,this.fieldsIndex),n=t.valueExpression,i=t.scale,a=n?{viewingMode:"map",scale:i,spatialReference:this.query.outSR||this.spatialReference}:null,e.abrupt("return",n?r.getExpressionValues(this.items,n,a,{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM}):r.getDataValues(this.items,{field:t.field,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,normalizationField:t.normalizationField,normalizationType:t.normalizationType,normalizationTotal:t.normalizationTotal}));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function ae(e,t,r,n){var i=n.x-r.x,a=n.y-r.y,s=i*i+a*a,u=(t.x-r.x)*i+(t.y-r.y)*a,o=Math.min(1,Math.max(0,u/s));e.x=r.x+i*o,e.y=r.y+a*o}function se(e,t){return e?t?4:3:t?3:2}var ue=function(){function e(t,r){(0,l.Z)(this,e),this.coords=t,this.coordsIndex=r}return(0,c.Z)(e,[{key:"x",get:function(){return this.coords[this.coordsIndex]}},{key:"y",get:function(){return this.coords[this.coordsIndex+1]}},{key:"z",get:function(){return this.coords[this.coordsIndex+2]}}]),e}(),oe=r(77095),ce=r(20311),le=r(52410),fe=r(67080);var he="feature-store:unsupported-query",pe=new y.WJ(2e6),de=0,ye=function(){function e(t){var r=this;(0,l.Z)(this,e),this._geometryQueryCache=null,this._changeHandle=null,this.capabilities={query:U.g},this.geometryType=t.geometryType,this.hasM=!!t.hasM,this.hasZ=!!t.hasZ,this.objectIdField=t.objectIdField,this.spatialReference=t.spatialReference,this.definitionExpression=t.definitionExpression,this.featureStore=t.featureStore,this.aggregateAdapter=t.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(function(){return r.clearCache()})),this.timeInfo=t.timeInfo,t.cacheSpatialQueries&&(this._geometryQueryCache=new y.Xq(de+++"$$",pe)),this.fieldsIndex=new le.Z(t.fields),t.scheduler&&t.priority&&(this._frameTask=t.scheduler.registerTask(t.priority))}return(0,c.Z)(e,[{key:"destroy",value:function(){this._frameTask=(0,d.hw)(this._frameTask),this.clearCache(),(0,d.SC)(this._geometryQueryCache),this._changeHandle=(0,d.hw)(this._changeHandle),(0,d.SC)(this.fieldsIndex)}},{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"clearCache",value:function(){var e;null!==(e=this._geometryQueryCache)&&void 0!==e&&e.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null}},{key:"executeQuery",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._executeQuery(t,{},r);case 3:return e.abrupt("return",e.sent.createQueryResponse());case 6:if(e.prev=6,e.t0=e.catch(0),e.t0===J.vF){e.next=10;break}throw e.t0;case 10:return e.abrupt("return",new ie([],t,this).createQueryResponse());case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForCount",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r,n=arguments;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},r=n.length>1?n[1]:void 0,e.prev=2,e.next=5,this._executeQuery(t,{returnGeometry:!1,returnCentroid:!1,outSR:null},r);case 5:return e.abrupt("return",e.sent.createQueryResponseForCount());case 8:if(e.prev=8,e.t0=e.catch(2),e.t0===J.vF){e.next=12;break}throw e.t0;case 12:return e.abrupt("return",0);case 13:case"end":return e.stop()}}),e,this,[[2,8]])})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.outSR,e.prev=1,e.next=4,this._executeQuery(t,{returnGeometry:!0,returnCentroid:!1,outSR:null},r);case 4:if(i=e.sent,a=i.size){e.next=8;break}return e.abrupt("return",{count:0,extent:null});case 8:return e.t0=a,e.next=11,this._getBounds(i.items,i.spatialReference,n||this.spatialReference);case 11:return e.t1=e.sent,e.abrupt("return",{count:e.t0,extent:e.t1});case 15:if(e.prev=15,e.t2=e.catch(1),e.t2!==J.vF){e.next=19;break}return e.abrupt("return",{count:0,extent:null});case 19:throw e.t2;case 20:case"end":return e.stop()}}),e,this,[[1,15]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeQueryForIdSet(t,r).then((function(e){return Array.from(e)})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIdSet",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._executeQuery(t,{returnGeometry:!0,returnCentroid:!1,outSR:null},r);case 3:return n=e.sent,i=n.items,a=new Set,e.next=8,this._reschedule((function(){var e,t=(0,s.Z)(i);try{for(t.s();!(e=t.n()).done;){var r=e.value;a.add(n.featureAdapter.getObjectId(r))}}catch(u){t.e(u)}finally{t.f()}}),r);case 8:return e.abrupt("return",a);case 11:if(e.prev=11,e.t0=e.catch(0),e.t0!==J.vF){e.next=15;break}return e.abrupt("return",new Set);case 15:throw e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,11]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForSnapping",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i,s,o,c,l,f,h,p,d,y,v,m,x,g,Z,F=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.point,i=t.distance,s=t.returnEdge,o=t.returnVertex,s||o){e.next=3;break}return e.abrupt("return",{candidates:[]});case 3:return e.next=5,this._reschedule((function(){return F._checkQuerySupport(t.query)}),r);case 5:if(c=e.sent,l=!(0,k.fS)(n.spatialReference,this.spatialReference),e.t0=l,!e.t0){e.next=11;break}return e.next=11,(0,H._W)(n.spatialReference,this.spatialReference);case 11:if(f="number"==typeof i?i:i.x,h="number"==typeof i?i:i.y,p={xmin:n.x-f,xmax:n.x+f,ymin:n.y-h,ymax:n.y+h,spatialReference:n.spatialReference},d=l?(0,H.iV)(p,this.spatialReference):p){e.next=14;break}return e.abrupt("return",{candidates:[]});case 14:return e.next=16,(0,b.aX)((0,_.im)(n),null,{signal:r});case 16:return y=e.sent[0],e.next=19,(0,b.aX)((0,_.im)(d),null,{signal:r});case 19:if(v=e.sent[0],null!=y&&null!=v){e.next=22;break}return e.abrupt("return",{candidates:[]});case 22:return e.t1=ie,e.next=25,this._reschedule((function(){return F._searchFeatures(F._getQueryBBoxes(v.toJSON()))}),r);case 25:return e.t2=e.sent,e.t3=c,e.t4=this,m=new e.t1(e.t2,e.t3,e.t4),e.next=31,this._reschedule((function(){return F._executeObjectIdsQuery(m)}),r);case 31:return e.next=33,this._reschedule((function(){return F._executeTimeQuery(m)}),r);case 33:return e.next=35,this._reschedule((function(){return F._executeAttributesQuery(m)}),r);case 35:return x=y.toJSON(),g=l?(0,H.iV)(x,this.spatialReference):x,Z=l?Math.max(d.xmax-d.xmin,d.ymax-d.ymin)/2:i,e.abrupt("return",m.createSnappingResponse((0,a.Z)((0,a.Z)({},t),{},{point:g,distance:Z}),n.spatialReference));case 37:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForLatestObservations",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.timeInfo&&this.timeInfo.trackIdField){e.next=2;break}throw new h.Z(he,"Missing timeInfo or timeInfo.trackIdField",{query:t,timeInfo:this.timeInfo});case 2:return e.prev=2,e.next=5,this._executeQuery(t,{},r);case 5:return n=e.sent,e.next=8,this._reschedule((function(){return i._filterLatest(n)}),r);case 8:return e.abrupt("return",n.createQueryResponse());case 11:if(e.prev=11,e.t0=e.catch(2),e.t0===J.vF){e.next=15;break}throw e.t0;case 15:return e.abrupt("return",new ie([],t,this).createQueryResponse());case 16:case"end":return e.stop()}}),e,this,[[2,11]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForSummaryStatistics",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r,n,i,a,s,o=arguments;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=o.length>0&&void 0!==o[0]?o[0]:{},n=o.length>2?o[2]:void 0,i=(r=o.length>1?o[1]:void 0).field,a=r.normalizationField,s=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:i,normalizationField:a,valueExpression:s},n);case 6:return e.abrupt("return",e.sent.createSummaryStatisticsResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForUniqueValues",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r,n,i,a,s,o,c=arguments;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=c.length>0&&void 0!==c[0]?c[0]:{},n=c.length>2?c[2]:void 0,i=(r=c.length>1?c[1]:void 0).field,a=r.field2,s=r.field3,o=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:i,field2:a,field3:s,valueExpression:o},n);case 6:return e.abrupt("return",e.sent.createUniqueValuesResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForClassBreaks",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r,n,i,a,s,o=arguments;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=o.length>0&&void 0!==o[0]?o[0]:{},n=o.length>2?o[2]:void 0,i=(r=o.length>1?o[1]:void 0).field,a=r.normalizationField,s=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:i,normalizationField:a,valueExpression:s},n);case 6:return e.abrupt("return",e.sent.createClassBreaksResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForHistogram",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r,n,i,a,s,o=arguments;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=o.length>0&&void 0!==o[0]?o[0]:{},n=o.length>2?o[2]:void 0,i=(r=o.length>1?o[1]:void 0).field,a=r.normalizationField,s=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:i,normalizationField:a,valueExpression:s},n);case 6:return e.abrupt("return",e.sent.createHistogramResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchRecomputedExtents",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,a,s;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=Promise,!("getFullExtent"in this.featureStore)||!this.featureStore.getFullExtent){e.next=5;break}e.t1=Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)),e.next=12;break;case 5:return e.t2=this,e.next=8,this._getAllFeatures();case 8:e.t3=e.sent,e.t4=this.spatialReference,e.t5=this.spatialReference,e.t1=e.t2._getBounds.call(e.t2,e.t3,e.t4,e.t5);case 12:return e.t6=e.t1,e.t7=null!=this._timeExtentPromise?this._timeExtentPromise:this._timeExtentPromise=(0,ce.R)(this.timeInfo,this.featureStore),e.t8=[e.t6,e.t7],e.next=17,e.t0.all.call(e.t0,e.t8);case 17:return r=e.sent,n=(0,i.Z)(r,2),a=n[0],s=n[1],e.abrupt("return",((0,v.k_)(t),{fullExtent:a,timeExtent:s}));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getBounds",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r,n){var i,a,s,o,c,l;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,x.t8)((0,x.Ue)(),x.Gv),e.next=3,this.featureStore.forEachBounds(t,(function(e){return(0,x.TC)(i,e)}));case 3:return a={xmin:i[0],ymin:i[1],xmax:i[3],ymax:i[4],spatialReference:(0,J.S2)(this.spatialReference)},this.hasZ&&isFinite(i[2])&&isFinite(i[5])&&(a.zmin=i[2],a.zmax=i[5]),(s=(0,H.iV)(a,r,n)).spatialReference=(0,J.S2)(n),s.xmax-s.xmin==0&&(o=(0,m.c9)(s.spatialReference),s.xmin-=o,s.xmax+=o),s.ymax-s.ymin==0&&(c=(0,m.c9)(s.spatialReference),s.ymin-=c,s.ymax+=c),this.hasZ&&null!=s.zmin&&null!=s.zmax&&s.zmax-s.zmin==0&&(l=(0,m.c9)(s.spatialReference),s.zmin-=l,s.zmax+=l),e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_schedule",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null!=this._frameTask?this._frameTask.schedule(t,r):t(fe.G5));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_reschedule",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null!=this._frameTask?this._frameTask.reschedule(t,r):t(fe.G5));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getAllFeaturesQueryEngineResult",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=ie,e.next=3,this._getAllFeatures();case 3:return e.t1=e.sent,e.t2=t,e.t3=this,e.abrupt("return",new e.t0(e.t1,e.t2,e.t3));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getAllFeatures",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(){var t,r,n,i=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null==this._allFeaturesPromise&&(t=[],this._allFeaturesPromise=(0,o.Z)((0,u.Z)().mark((function e(){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.featureStore.forEach((function(e){return t.push(e)}));case 2:case"end":return e.stop()}}),e)})))().then((function(){return t}))),r=this._allFeaturesPromise,e.next=4,r;case 4:return n=e.sent,e.abrupt("return",r===this._allFeaturesPromise?n.slice():this._getAllFeatures());case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_executeQuery",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r,n){var i,s,o=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,p.d9)(t),e.next=3,this._schedule((function(){return(0,J.Up)(t,o.definitionExpression,o.spatialReference)}),n);case 3:return t=e.sent,e.next=6,this._reschedule((function(){return o._checkQuerySupport(t)}),n);case 6:return t=e.sent,t=(0,a.Z)((0,a.Z)({},t),r),e.next=10,this._reschedule((function(){return o._executeSceneFilterQuery(t,n)}),n);case 10:return i=e.sent,e.next=13,this._reschedule((function(){return o._executeGeometryQuery(t,i,n)}),n);case 13:return s=e.sent,e.next=16,this._reschedule((function(){return o._executeAggregateIdsQuery(s)}),n);case 16:return e.next=18,this._reschedule((function(){return o._executeObjectIdsQuery(s)}),n);case 18:return e.next=20,this._reschedule((function(){return o._executeTimeQuery(s)}),n);case 20:return e.next=22,this._reschedule((function(){return o._executeAttributesQuery(s)}),n);case 22:return e.abrupt("return",s);case 23:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_executeSceneFilterQuery",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i,a,c,l,f,h,p,d,y,v,m,x,g,Z,_,b,F,w=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.sceneFilter){e.next=2;break}return e.abrupt("return",null);case 2:if(n=t.outSR,i=t.returnGeometry,a=t.returnCentroid,c=this.featureStore.featureSpatialReference,l=t.sceneFilter.geometry,f=null==c||(0,k.fS)(c,l.spatialReference)?l:(0,H.iV)(l,c)){e.next=5;break}return e.abrupt("return",null);case 5:return h=i||a,p=(0,k.JY)(n)&&!(0,k.fS)(this.spatialReference,n)&&h?function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",w._project(t,n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}():function(e){return e},d=this.featureAdapter,e.next=10,this._reschedule((function(){return w._searchFeatures(w._getQueryBBoxes(f))}),r);case 10:if(y=e.sent,"disjoint"!==t.sceneFilter.spatialRelationship){e.next=24;break}if(y.length){e.next=14;break}return e.abrupt("return",null);case 14:v=new Set,m=(0,s.Z)(y);try{for(m.s();!(x=m.n()).done;)g=x.value,v.add(d.getObjectId(g))}catch(S){m.e(S)}finally{m.f()}return e.next=19,this._reschedule((function(){return w._getAllFeatures()}),r);case 19:return Z=e.sent,e.next=22,this._reschedule((0,o.Z)((0,u.Z)().mark((function e(){var n,i,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,oe.cW)("esriSpatialRelDisjoint",f,w.geometryType,w.hasZ,w.hasM);case 2:return n=e.sent,i=function(e){return!v.has(d.getObjectId(e))||n(d.getGeometry(e))},e.next=6,w._runSpatialFilter(Z,i,r);case 6:return a=e.sent,e.abrupt("return",new ie(a,t,w));case 8:case"end":return e.stop()}}),e)}))),r);case 22:return _=e.sent,e.abrupt("return",p(_));case 24:if(y.length){e.next=26;break}return e.abrupt("return",new ie([],t,this));case 26:if(!this._canExecuteSinglePass(f,t)){e.next=28;break}return e.abrupt("return",p(new ie(y,t,this)));case 28:return e.next=30,(0,oe.cW)("esriSpatialRelContains",f,this.geometryType,this.hasZ,this.hasM);case 30:return b=e.sent,e.next=33,this._runSpatialFilter(y,(function(e){return b(d.getGeometry(e))}),r);case 33:return F=e.sent,e.abrupt("return",p(new ie(F,t,this)));case 35:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_executeGeometryQuery",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r,n){var i,a,c,l,h,p,d,y,v,m,x,g,Z,_,b,F,w,S,I,R,T,A,V,Q,C,E=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==r||0!==r.items.length){e.next=2;break}return e.abrupt("return",r);case 2:if(t=null!=r?r.query:t,a=(i=t).geometry,c=i.outSR,l=i.spatialRel,h=i.returnGeometry,p=i.returnCentroid,d=this.featureStore.featureSpatialReference,y=!a||null==d||(0,k.fS)(d,a.spatialReference)?a:(0,H.iV)(a,d),v=h||p,m=(0,k.JY)(c)&&!(0,k.fS)(this.spatialReference,c),x=this._geometryQueryCache&&null==r?m&&v?JSON.stringify({originalFilterGeometry:a,spatialRelationship:l,outSpatialReference:c}):JSON.stringify({originalFilterGeometry:a,spatialRelationship:l}):null,null==(g=x?this._geometryQueryCache.get(x):null)){e.next=6;break}return e.abrupt("return",new ie(g,t,this));case 6:if(Z=function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=m&&v,!e.t0){e.next=4;break}return e.next=4,E._project(t,c);case 4:return x&&E._geometryQueryCache.put(x,t.items,t.items.length+1),e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y){e.next=18;break}if(e.t0=Z,null==r){e.next=13;break}e.t1=r,e.next=16;break;case 13:return e.next=15,this._getAllFeaturesQueryEngineResult(t);case 15:e.t1=e.sent;case 16:return e.t2=e.t1,e.abrupt("return",(0,e.t0)(e.t2));case 18:return _=this.featureAdapter,e.next=21,this._reschedule((function(){return E._searchFeatures(E._getQueryBBoxes(a))}),n);case 21:if(b=e.sent,"esriSpatialRelDisjoint"!==l){e.next=49;break}if(b.length){e.next=34;break}if(e.t3=Z,null==r){e.next=29;break}e.t4=r,e.next=32;break;case 29:return e.next=31,this._getAllFeaturesQueryEngineResult(t);case 31:e.t4=e.sent;case 32:return e.t5=e.t4,e.abrupt("return",(0,e.t3)(e.t5));case 34:F=new Set,w=(0,s.Z)(b);try{for(w.s();!(S=w.n()).done;)I=S.value,F.add(_.getObjectId(I))}catch(z){w.e(z)}finally{w.f()}if(null==r){e.next=41;break}e.t6=r.items,e.next=44;break;case 41:return e.next=43,this._reschedule((function(){return E._getAllFeatures()}),n);case 43:e.t6=e.sent;case 44:return R=e.t6,e.next=47,this._reschedule((0,o.Z)((0,u.Z)().mark((function e(){var r,i,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,oe.cW)(l,y,E.geometryType,E.hasZ,E.hasM);case 2:return r=e.sent,i=function(e){return!F.has(_.getObjectId(e))||r(_.getGeometry(e))},e.next=6,E._runSpatialFilter(R,i,n);case 6:return a=e.sent,e.abrupt("return",new ie(a,t,E));case 8:case"end":return e.stop()}}),e)}))),n);case 47:return T=e.sent,e.abrupt("return",Z(T));case 49:if(null!=r&&(A=new f.SO,b=b.filter((function(e){return(0,f.cq)(r.items,e,r.items.length,A)>=0}))),b.length){e.next=53;break}return V=new ie([],t,this),e.abrupt("return",(x&&this._geometryQueryCache.put(x,V.items,1),V));case 53:if(!this._canExecuteSinglePass(y,t)){e.next=55;break}return e.abrupt("return",Z(new ie(b,t,this)));case 55:return e.next=57,(0,oe.cW)(l,y,this.geometryType,this.hasZ,this.hasM);case 57:return Q=e.sent,e.next=60,this._runSpatialFilter(b,(function(e){return Q(_.getGeometry(e))}),n);case 60:return C=e.sent,e.abrupt("return",Z(new ie(C,t,this)));case 62:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_executeAggregateIdsQuery",value:function(e){if(0!==e.items.length&&e.query.aggregateIds&&e.query.aggregateIds.length&&null!=this.aggregateAdapter){var t,r=new Set,n=(0,s.Z)(e.query.aggregateIds);try{for(n.s();!(t=n.n()).done;){var i=t.value;this.aggregateAdapter.getFeatureObjectIds(i).forEach((function(e){return r.add(e)}))}}catch(u){n.e(u)}finally{n.f()}var a=this.featureAdapter.getObjectId;e.items=e.items.filter((function(e){return r.has(a(e))}))}}},{key:"_executeObjectIdsQuery",value:function(e){if(0!==e.items.length&&e.query.objectIds&&e.query.objectIds.length){var t=new Set(e.query.objectIds),r=this.featureAdapter.getObjectId;e.items=e.items.filter((function(e){return t.has(r(e))}))}}},{key:"_executeTimeQuery",value:function(e){if(0!==e.items.length){var t=(0,ce.y)(this.timeInfo,e.query.timeExtent,this.featureAdapter);null!=t&&(e.items=e.items.filter(t))}}},{key:"_executeAttributesQuery",value:function(e){var t=this;if(0!==e.items.length){var r=G(e.query.where,this.fieldsIndex);if(r){if(!r.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter((function(e){return r.testFeature(e,t.featureAdapter)}))}}}},{key:"_runSpatialFilter",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r,n){var i,a,s,c=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return",t);case 2:if(null!=this._frameTask){e.next=4;break}return e.abrupt("return",t.filter((function(e){return r(e)})));case 4:return i=0,a=new Array,s=function(){var e=(0,o.Z)((0,u.Z)().mark((function e(o){var l;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i<t.length)){e.next=9;break}if(l=t[i++],r(l)&&(a.push(l),o.madeProgress()),e.t0=o.done,!e.t0){e.next=7;break}return e.next=7,c._reschedule((function(e){return s(e)}),n);case 7:e.next=0;break;case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.abrupt("return",this._reschedule((function(e){return s(e)}),n).then((function(){return a})));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_filterLatest",value:function(e){var t,r=this.timeInfo,n=r.trackIdField,i=r.startTimeField,a=r.endTimeField||i,u=new Map,o=this.featureAdapter.getAttribute,c=(0,s.Z)(e.items);try{for(c.s();!(t=c.n()).done;){var l=t.value,f=o(l,n),h=o(l,a),p=u.get(f);(!p||h>o(p,a))&&u.set(f,l)}}catch(d){c.e(d)}finally{c.f()}e.items=Array.from(u.values())}},{key:"_canExecuteSinglePass",value:function(e,t){var r=t.spatialRel;return(0,oe.hN)(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r||"esriSpatialRelWithin"===r))}},{key:"_project",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i,a=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r&&!(0,k.fS)(this.spatialReference,r)){e.next=2;break}return e.abrupt("return",t);case 2:return n=this.featureAdapter,e.next=5,(0,H.oj)(t.items.map((function(e){return(0,J.Op)(a.geometryType,a.hasZ,a.hasM,n.getGeometry(e))})),this.spatialReference,r);case 5:return i=e.sent,e.abrupt("return",(t.items=i.map((function(e,r){return n.cloneWithGeometry(t.items[r],(0,F.GH)(e,a.hasZ,a.hasM))})),t));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getQueryBBoxes",value:function(e){if((0,oe.hN)(e)){if((0,_.YX)(e))return[(0,g.al)(e.xmin,e.ymin,e.xmax,e.ymax)];if((0,_.oU)(e))return e.rings.map((function(e){return(0,g.al)(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))}))}return[(0,Z.$P)((0,g.Ue)(),e)]}},{key:"_searchFeatures",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r,n,i=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Set,e.next=3,Promise.all(t.map((function(e){return i.featureStore.forEachInBounds(e,(function(e){return r.add(e)}))})));case 3:return n=Array.from(r.values()),e.abrupt("return",(r.clear(),n));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_checkStatisticsSupport",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((null!==(n=t.distance)&&void 0!==n?n:0)<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text||t.outStatistics||t.groupByFieldsForStatistics||t.having||t.orderByFields)){e.next=2;break}throw new h.Z(he,"Unsupported query options",{query:t});case 2:return e.abrupt("return",(this._checkAttributesQuerySupport(t),Promise.all([this._checkStatisticsParamsSupport(r,t),(0,oe.P0)(t,this.geometryType,this.spatialReference),(0,H._W)(this.spatialReference,t.outSR)]).then((function(){return t}))));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_checkStatisticsParamsSupport",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r){var n,i,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],!t.valueExpression){e.next=7;break}return e.next=4,(0,K.LC)();case 4:i=e.sent,a=i.arcadeUtils,n=a.extractFieldNames(t.valueExpression);case 7:if(t.field&&n.push(t.field),t.field2&&n.push(t.field2),t.field3&&n.push(t.field3),t.normalizationField&&n.push(t.normalizationField),n.length||t.valueExpression){e.next=9;break}throw new h.Z(he,"field or valueExpression is required",{params:t});case 9:N(this.fieldsIndex,n,{errorMessage:"Cannot calculate statistics for missing fields",query:r}),O(this.fieldsIndex,n,{expressionName:"statistics",query:r});case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_checkQuerySupport",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t){var r;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((null!==(r=t.distance)&&void 0!==r?r:0)<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text)){e.next=2;break}throw new h.Z(he,"Unsupported query options",{query:t});case 2:return e.abrupt("return",(this._checkAttributesQuerySupport(t),this._checkStatisticsQuerySupport(t),Promise.all([(0,oe.P0)(t,this.geometryType,this.spatialReference),(0,H._W)(this.spatialReference,t.outSR)]).then((function(){return t}))));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_checkAttributesQuerySupport",value:function(e){var t=e.outFields,r=e.orderByFields,n=e.returnDistinctValues,i=e.outStatistics,a=i?i.map((function(e){return e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()})).filter(Boolean):[];if(r&&r.length>0){var s=" asc",u=" desc",o=r.map((function(e){var t=e.toLowerCase();return t.includes(s)?t.split(s)[0]:t.includes(u)?t.split(u)[0]:e})).filter((function(e){return!a.includes(e)}));N(this.fieldsIndex,o,{expressionName:"orderByFields",query:e})}if(t&&t.length>0)N(this.fieldsIndex,t,{expressionName:"outFields",query:e});else if(n)throw new h.Z(he,"outFields should be specified for returnDistinctValues",{query:e});!function(e,t,r){if(!t)return!0;var n="where clause",i=M(t,e,{validateStandardized:!0,expressionName:n});N(e,i,{expressionName:n,query:r}),O(e,i,{expressionName:n,query:r})}(this.fieldsIndex,e.where,e)}},{key:"_checkStatisticsQuerySupport",value:function(e){var t=e.outStatistics,r=e.groupByFieldsForStatistics,i=e.having,a=r&&r.length,u=t&&t.length;if(i){if(!a||!u)throw new h.Z(he,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});P(this.fieldsIndex,i,t,e)}if(u){if(!function(e){return null!=e&&e.every((function(e){return"exceedslimit"!==e.statisticType}))}(t))return;var o=t.map((function(e){return e.onStatisticField})).filter(Boolean);N(this.fieldsIndex,o,{expressionName:"onStatisticFields",query:e}),a&&N(this.fieldsIndex,r,{expressionName:"groupByFieldsForStatistics",query:e});var c,l=new Set([].concat((0,n.Z)(C.jsonValues),(0,n.Z)(E.jsonValues))),f=new Intl.ListFormat("en-US",{type:"conjunction"}).format([].concat((0,n.Z)(C.apiValues),(0,n.Z)(E.apiValues))),p=(0,s.Z)(t);try{for(p.s();!(c=p.n()).done;){var d=c.value,y=d.onStatisticField,v=d.statisticType;if("percentile_disc"!==v&&"percentile_cont"!==v||!("statisticParameters"in d)){if("count"!==v&&"min"!==v&&"max"!==v&&y&&L(y,this.fieldsIndex,l))throw new h.Z(he,"outStatistics with '".concat(v,"' statistic type, only supports ").concat(f," field types"),{definition:d,query:e})}else if(!d.statisticParameters)throw new h.Z(he,"statisticParameters should be set for percentile type",{definition:d,query:e})}}catch(m){p.e(m)}finally{p.f()}}}},{key:"_getQueryEngineResultForStats",value:function(){var e=(0,o.Z)((0,u.Z)().mark((function e(t,r,n){var i,a,s=this;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,p.d9)(t),e.prev=1,e.next=4,this._schedule((function(){return(0,J.Up)(t,s.definitionExpression,s.spatialReference)}),n);case 4:return t=e.sent,e.next=7,this._reschedule((function(){return s._checkStatisticsSupport(t,r)}),n);case 7:return t=e.sent,e.next=10,this._reschedule((function(){return s._executeSceneFilterQuery(t,n)}),n);case 10:return i=e.sent,e.next=13,this._reschedule((function(){return s._executeGeometryQuery(t,i,n)}),n);case 13:return a=e.sent,e.next=16,this._reschedule((function(){return s._executeAggregateIdsQuery(a)}),n);case 16:return e.next=18,this._reschedule((function(){return s._executeObjectIdsQuery(a)}),n);case 18:return e.next=20,this._reschedule((function(){return s._executeTimeQuery(a)}),n);case 20:return e.next=22,this._reschedule((function(){return s._executeAttributesQuery(a)}),n);case 22:return e.abrupt("return",a);case 25:if(e.prev=25,e.t0=e.catch(1),e.t0===J.vF){e.next=29;break}throw e.t0;case 29:return e.abrupt("return",new ie([],t,this));case 30:case"end":return e.stop()}}),e,this,[[1,25]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]),e}()},60480:function(e,t,r){r.d(t,{g:function(){return n}});var n={supportsStatistics:!0,supportsPercentileStatistics:!0,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsCentroid:!0,supportsCacheHint:!1,supportsDistance:!0,supportsDistinct:!0,supportsExtent:!0,supportsGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryGeometry:!0,supportsResultType:!1,supportsSqlExpression:!0,supportsMaxRecordCountFactor:!1,supportsStandardizedQueriesOnly:!0,supportsTopFeaturesQuery:!1,supportsQueryByOthers:!0,supportsHistoricMoment:!1,supportsFormatPBF:!1,supportsDisjointSpatialRelationship:!0,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,maxRecordCountFactor:void 0,maxRecordCount:void 0,standardMaxRecordCount:void 0,tileMaxRecordCount:void 0}}}]);
//# sourceMappingURL=7011.ea3301dc.chunk.js.map