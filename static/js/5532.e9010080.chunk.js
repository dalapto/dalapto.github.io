"use strict";(self.webpackChunkreact_arcgis=self.webpackChunkreact_arcgis||[]).push([[5532],{25532:function(e,t,r){r.r(t),r.d(t,{uploadAssets:function(){return Z}});var n=r(74165),a=r(37762),s=r(15861),o=r(76200),u=r(10064),c=r(32718),p=r(66978),i=r(35995),l=r(71907),f=r(17493),d=r(25899),h=1e6,y=20*h,m=2e9,w=3;function v(e,t,r){return x.apply(this,arguments)}function x(){return x=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var u,c,l,f,v,x,b,Z,k,g,T,E,_,j,F,D,U,A,N,S,C,I,P,L,R,q,z,B;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=t.data,c=t.name,l=t.description,f=null,e.prev=2,v=(0,i.v_)(r,"uploads"),x=(0,i.v_)(v,"info"),e.next=7,(0,o.default)(x,{query:{f:"json"},responseType:"json"});case 7:if(b=e.sent,Z=b.data,(0,p.k_)(a),k=(0,d.M8)(r),g=Z.maxUploadFileSize*h,T=k?m:g,E=k?Math.min(y,g):y,!(u.size>T)){e.next=13;break}throw new Error("Data too large");case 13:return _=(0,i.v_)(v,"register"),e.next=16,(0,o.default)(_,{query:{f:"json",itemName:c,description:l},responseType:"json",method:"post"});case 16:if(j=e.sent,F=j.data,(0,p.k_)(a),F.success){e.next=20;break}throw new Error("Registration failed");case 20:for(D=F.item.itemID,f=(0,i.v_)(v,D),U=(0,i.v_)(f,"uploadPart"),A=Math.ceil(u.size/E),N=new Array,S=0;S<A;++S)N.push(u.slice(S*E,Math.min((S+1)*E,u.size)));for(C=N.slice().reverse(),I=new Array,P=function(){var e=(0,s.Z)((0,n.Z)().mark((function e(){var t,r,s,u,c;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===C.length){e.next=11;break}return t=N.length-C.length,r=C.pop(),(s=new FormData).append("f","json"),s.append("file",r),s.append("partId","".concat(t)),e.next=5,(0,o.default)(U,{timeout:0,body:s,responseType:"json",method:"post"});case 5:if(u=e.sent,c=u.data,(0,p.k_)(a),c.success){e.next=9;break}throw new Error("Part upload failed");case 9:e.next=0;break;case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),L=0;L<w&&0!==C.length;++L)I.push(P());return e.next=28,Promise.all(I);case 28:return R=(0,i.v_)(f,"commit"),e.next=31,(0,o.default)(R,{query:{f:"json",parts:N.map((function(e,t){return t})).join(",")},responseType:"json",method:"post"});case 31:if(q=e.sent,z=q.data,(0,p.k_)(a),z.success){e.next=35;break}throw new Error("Commit failed");case 35:return e.abrupt("return",z.item);case 38:if(e.prev=38,e.t0=e.catch(2),null==f){e.next=44;break}return B=(0,i.v_)(f,"delete"),e.next=44,(0,o.default)(B,{query:{f:"json"},responseType:"json",method:"post"});case 44:throw e.t0;case 45:case"end":return e.stop()}}),e,null,[[2,38]])}))),x.apply(this,arguments)}var b=r(18277);function Z(e,t,r){return k.apply(this,arguments)}function k(){return(k=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.length?Promise.all(t.map((function(e){return g(e,r,a)}))):[]);case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e,t,r){return T.apply(this,arguments)}function T(){return T=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,o,c,p;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.layer,o=r.ongoingUploads,!(c=o.get(t))){e.next=4;break}return e.abrupt("return",c);case 4:if(ee(s)){e.next=6;break}throw new u.Z("".concat(s.type,"-layer:upload-failure"),"Layer does not support asset uploads.",new Error);case 6:if(!E(t,s)){e.next=8;break}return e.abrupt("return",t);case 8:return p=_(t,s,a),o.set(t,p),e.prev=10,e.next=13,p;case 13:return e.prev=13,o.delete(t),e.finish(13);case 16:return e.abrupt("return",t);case 17:case"end":return e.stop()}}),e,null,[[10,,13,16]])}))),T.apply(this,arguments)}function E(e,t){var r=t.parsedUrl;return null!=r&&e.metadata.externalSources.some((function(e){return(0,f.JG)(e,r)}))}function _(e,t,r){return j.apply(this,arguments)}function j(){return j=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,o,u,c,i,l,f;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.metadata,o=s.displaySource,u=L(null===o||void 0===o?void 0:o.source,r),c=!!u,i=s.externalSources.length>0,l=c?F(u,r,a):i?U(t,r,a):N(t,r,a),e.next=8,l;case 8:return f=e.sent,e.abrupt("return",((0,p.k_)(a),t.addExternalSources([f]),t));case 10:case"end":return e.stop()}}),e)}))),j.apply(this,arguments)}function F(e,t,r){return D.apply(this,arguments)}function D(){return(D=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,q(t,r,a);case 2:return e.t0=e.sent,e.t1=!0,e.abrupt("return",{source:e.t0,original:e.t1});case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(e,t,r){return A.apply(this,arguments)}function A(){return A=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,o,c,p;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=te(r),o=t.metadata.externalSources,c=P(o,r)){e.next=3;break}throw new u.Z("".concat(r.type,"-layer:upload-failure"),"Could not find an external source that is supported by the service.",new Error);case 3:return e.next=5,q(c,r,a);case 5:return p=e.sent,t.addExternalSources([{source:p,original:!0}]),e.next=9,V(p,r,s);case 9:return e.t0=e.sent,e.abrupt("return",{source:e.t0});case 11:case"end":return e.stop()}}),e)}))),A.apply(this,arguments)}function N(e,t,r){return S.apply(this,arguments)}function S(){return S=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=C(t,r,a),e.next=3,B([s],r,a);case 3:return e.t0=e.sent,e.t1=t.extent.clone(),e.t2=!0,e.abrupt("return",{source:e.t0,extent:e.t1,original:e.t2});case 7:case"end":return e.stop()}}),e)}))),S.apply(this,arguments)}function C(e,t,r){return I.apply(this,arguments)}function I(){return I=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,o,u,c;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=te(r),e.next=3,t.load(a);case 3:return o=e.sent,e.next=6,o.toBinaryGLTF({ignoreLocalTransform:!0});case 6:return u=e.sent,(0,p.k_)(a),e.next=10,u.buffer();case 10:return c=e.sent,e.abrupt("return",((0,p.k_)(a),{blob:new Blob([c.data],{type:c.type}),assetName:"".concat((0,l.z)(),".glb"),assetType:s}));case 12:case"end":return e.stop()}}),e)}))),I.apply(this,arguments)}function P(e,t){var r,n=(0,a.Z)(e);try{for(n.s();!(r=n.n()).done;){var s=L(r.value.source,t);if(s)return s}}catch(o){n.e(o)}finally{n.f()}return null}function L(e,t){if(!e)return null;for(var r=t.infoFor3D,n=r.supportedFormats,a=r.editFormats,s=(0,f.zE)(e),o=new Array,u=!1,c=0;c<s.length;++c){var p=R(s[c],n);if(!p)return null;a.includes(p.assetType)&&(u=!0),o.push(p)}return u?o:null}function R(e,t){var r=(0,f.vj)(e,t);return r?{asset:e,assetType:r}:null}function q(e,t,r){return z.apply(this,arguments)}function z(){return(z=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",B(t.map((function(e){return M(e,a)})),r,a));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function B(e,t,r){return H.apply(this,arguments)}function H(){return H=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var o,u,c;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(t.map(function(){var e=(0,s.Z)((0,n.Z)().mark((function e(t){var s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=J,e.next=3,t;case 3:return e.t1=e.sent,e.t2=r,e.t3=a,s=(0,e.t0)(e.t1,e.t2,e.t3),e.abrupt("return",((0,p.k_)(a),s));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:return o=e.sent,(0,p.k_)(a),e.next=6,W(o.map((function(e){return e.item})),r,a);case 6:return u=e.sent,c=u.uploadResults,e.abrupt("return",((0,p.k_)(a),t.map((function(e,t){return Q(o[t],c[t],r)}))));case 9:case"end":return e.stop()}}),e)}))),H.apply(this,arguments)}function M(e,t){return O.apply(this,arguments)}function O(){return O=(0,s.Z)((0,n.Z)().mark((function e(t,r){var a,s,o;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.asset,s=t.assetType,!(a instanceof File)){e.next=3;break}return e.abrupt("return",{blob:a,assetName:a.name,assetType:s});case 3:return e.next=5,a.toBlob(r);case 5:return o=e.sent,e.abrupt("return",((0,p.k_)(r),{blob:o,assetName:a.assetName,assetType:s}));case 7:case"end":return e.stop()}}),e)}))),O.apply(this,arguments)}function J(e,t,r){return G.apply(this,arguments)}function G(){return G=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,o,l,f,d,h;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.blob,o=t.assetType,l=t.assetName,f=null,e.prev=2,e.next=5,v({data:s,name:l},r.url,a);case 5:d=e.sent,(0,p.k_)(a),f={assetType:o,assetUploadId:d.itemID},e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),(0,p.r9)(e.t0),c.Z.getLogger("esri.layers.graphics.sources.support.uploadAssets").warnOnce("Service ".concat(r.url," does not support the REST Uploads API."));case 12:if(f){e.next=19;break}return e.next=15,(0,i.IR)(s);case 15:if(h=e.sent,(0,p.k_)(a),h.isBase64){e.next=18;break}throw new u.Z("".concat(r.type,"-layer:uploadAssets-failure"),"Expected gltf data in base64 format after conversion.",new Error);case 18:f={assetType:o,assetData:h.data};case 19:if(f){e.next=21;break}throw new u.Z("".concat(r.type,"-layer:uploadAssets-failure"),"Unable to prepare uploadAsset request options.",new Error);case 21:return e.abrupt("return",{item:f,assetName:l});case 22:case"end":return e.stop()}}),e,null,[[2,9]])}))),G.apply(this,arguments)}function W(e,t,r){return K.apply(this,arguments)}function K(){return K=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.default)((0,i.v_)(r.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(t)},method:"post",responseType:"json"});case 2:if(s=e.sent,(0,p.k_)(a),s.data.uploadResults.length===t.length){e.next=5;break}throw new u.Z("".concat(r.type,"-layer:uploadAssets-failure"),"Bad response. Uploaded ".concat(t.length," items and received ").concat(s.data.uploadResults.length," results."),new Error);case 5:return e.abrupt("return",s.data);case 6:case"end":return e.stop()}}),e)}))),K.apply(this,arguments)}function Q(e,t,r){if(!t.success){var n=t.error;throw new u.Z("".concat(r.type,"-layer:upload-failure"),"Failed to upload mesh file ".concat(e.assetName,". Error code: ").concat(n.code,". Error message: ").concat(n.messages),new Error)}var a=t.assetHash,s=e.assetName,o=e.item.assetType,c=r.infoFor3D.supportedFormats,p=(0,b.d1)(o,c);if(!p)throw new u.Z("".concat(r.type,"-layer:upload-failure"),"The service allowed us to upload an asset of FormatID ".concat(o,", but it does not list it in its supported formats."),new Error);return new f.CP(s,p,[new f.LL("".concat(r.parsedUrl.path,"/assets/").concat(a),a)])}function V(e,t,r){return X.apply(this,arguments)}function X(){return X=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,c,p,l,d,h,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=t.map((function(e){return{assetName:e.assetName,assetHash:e.parts[0].partHash}})),p=null===(s=r.capabilities)||void 0===s?void 0:s.operations.supportsAsyncConvert3D,l={query:{f:"json",assets:JSON.stringify(c),transportType:"esriTransportTypeUrl",targetFormat:a,async:p},responseType:"json",timeout:0},d=(0,i.v_)(r.parsedUrl.path,"convert3D"),!p){e.next=10;break}return e.next=7,Y(d,l);case 7:e.t0=e.sent,e.next=13;break;case 10:return e.next=12,(0,o.default)(d,l);case 12:e.t0=e.sent;case 13:return h=e.t0.data,y=r.infoFor3D.supportedFormats,e.abrupt("return",h.assets.map((function(e){var t=(0,b.S0)(e.contentType,y);if(!t)throw new u.Z("".concat(r.type,"-layer:upload-failure"),"The service allowed us to upload an asset of FormatID ".concat(t,", but it does not list it in its supported formats."),new Error);return new f.CP(e.assetName,e.contentType,[new f.LL(e.assetURL,e.assetHash)])})));case 16:case"end":return e.stop()}}),e)}))),X.apply(this,arguments)}function Y(e,t){return $.apply(this,arguments)}function $(){return $=(0,s.Z)((0,n.Z)().mark((function e(t,r){var a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.default)(t,r);case 2:a=e.sent.data.statusUrl;case 3:return e.next=5,(0,o.default)(a,{query:{f:"json"},responseType:"json"});case 5:s=e.sent.data,e.t0=s.status,e.next="Completed"===e.t0?9:"CompletedWithErrors"===e.t0?10:"Failed ImportChanges"===e.t0||"InProgress"===e.t0||"Pending"===e.t0||"ExportAttachments"===e.t0||"ExportChanges"===e.t0||"ExportingData"===e.t0||"ExportingSnapshot"===e.t0||"ImportAttachments"===e.t0||"ProvisioningReplica"===e.t0||"UnRegisteringReplica"===e.t0?11:12;break;case 9:return e.abrupt("return",(0,o.default)(s.resultUrl,{query:{f:"json"},responseType:"json"}));case 10:throw new u.Z("async-convert3D-failed","asynchronous convert3D call failed.");case 11:return e.abrupt("break",13);case 12:throw new u.Z("async-convert3D-failed","asynchronous convert3D call failed (undefined response status)");case 13:return e.next=15,(0,p.e4)(re);case 15:e.next=3;break;case 17:case"end":return e.stop()}}),e)}))),$.apply(this,arguments)}function ee(e){return!!e.infoFor3D&&!!e.url}function te(e){var t,r=e.infoFor3D,n=null!==(t=(0,b.S0)("model/gltf-binary",r.supportedFormats))&&void 0!==t?t:(0,b.Ow)("glb",r.supportedFormats);if(!n)throw new u.Z("".concat(e.type,"-layer:upload-failure"),"Layer does not support glb.",new Error);return n}var re=1e3}}]);
//# sourceMappingURL=5532.e9010080.chunk.js.map