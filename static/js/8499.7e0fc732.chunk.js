"use strict";(self.webpackChunkreact=self.webpackChunkreact||[]).push([[8499],{51e3:function(e,t,r){r.d(t,{J:function(){return a},r:function(){return s}});var i=null,n=!0;function s(e,t,r){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(n)try{return new ImageData(e,t)}catch(o){n=!1}return u(e,t,r)}function a(e,t,r,i){if(!t||!r)throw new Error("Cannot construct image data without dimensions");if(n)try{return new ImageData(e,t,r)}catch(a){n=!1}var s=u(t,r,i);return s.data.set(e,0),s}function o(){return i||((i=document.createElement("canvas")).width=1,i.height=1),i}function u(e,t,r){return r||(r=o()),r.getContext("2d").createImageData(e,t)}},38330:function(e,t,r){r.d(t,{t:function(){return o}});var i=r(74165),n=r(1413),s=r(15861),a=r(76200);function o(e,t){return u.apply(this,arguments)}function u(){return u=(0,s.Z)((0,i.Z)().mark((function e(t,r){var s,o;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.default)(t,(0,n.Z)({responseType:"image"},r));case 2:return s=e.sent,o=s.data,e.abrupt("return",o);case 5:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}},17653:function(e,t,r){r.d(t,{Z:function(){return k}});var i=r(1413),n=r(74165),s=r(15861),a=r(15671),o=r(43144),u=r(76200),l=r(10064),h=r(82272),c=r(66978),d=r(1370),f=r(37762),_=r(52522),p=r(38499);function v(e,t){return g.apply(this,arguments)}function g(){return g=(0,s.Z)((0,n.Z)().mark((function e(t,r){var i,s,a,o,u,l,h,d,v,g,m,b,y,w;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=(0,_.p)(t))instanceof Error)){e.next=3;break}throw i;case 3:return e.next=5,i.createImages();case 5:(0,c.k_)(r),s=i.frames,a=i.width,o=i.height,(u=document.createElement("canvas")).width=a,u.height=o,l=u.getContext("2d",{willReadFrequently:!0}),h=[],d=[],v=(0,f.Z)(s);try{for(v.s();!(g=v.n()).done;)m=g.value,d.push((0,p.HA)(m.delay||100)),b=m.imageElement,0===m.blendOp?l.globalCompositeOperation="copy":l.globalCompositeOperation="source-over",y=2===m.disposeOp?l.getImageData(m.left,m.top,m.width,m.height):void 0,l.drawImage(b,m.left,m.top),w=l.getImageData(0,0,a,o),h.push(w),0===m.disposeOp||(1===m.disposeOp?l.clearRect(m.left,m.top,m.width,m.height):2===m.disposeOp&&l.putImageData(y,m.left,m.top))}catch(n){v.e(n)}finally{v.f()}return e.abrupt("return",{frameDurations:d,getFrame:function(e){return h[e]},width:a,height:o});case 12:case"end":return e.stop()}}),e)}))),g.apply(this,arguments)}var m=[137,80,78,71,13,10,26,10];function b(e){var t=new Uint8Array(e);return!m.some((function(e,r){return e!==t[r]}))}function y(e){if(!b(e))return!1;var t,r=new DataView(e),i=new Uint8Array(e),n=8;do{var s=r.getUint32(n);if("acTL"===(t=String.fromCharCode.apply(String,Array.prototype.slice.call(i.subarray(n+4,n+8)))))return!0;n+=12+s}while("IEND"!==t&&n<i.length);return!1}var w=r(91958),x=r(47191);function T(e,t){return B.apply(this,arguments)}function B(){return B=(0,s.Z)((0,n.Z)().mark((function e(t,r){var i,s,a,o,u,l,h,c,d,_,v,g,m,b,y,T;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=(0,x.p)(t),s=(0,x.d)(i,!0),a=i.lsd,o=a.width,u=a.height,(l=document.createElement("canvas")).width=o,l.height=u,h=l.getContext("2d",{willReadFrequently:!0}),c=[],d=[],_=(0,f.Z)(s);try{for(_.s();!(v=_.n()).done;)g=v.value,d.push((0,p.HA)(g.delay||100)),m=new ImageData(g.patch,g.dims.width,g.dims.height),b=(0,w.E0)(m),y=3===g.disposalType?h.getImageData(g.dims.left,g.dims.top,g.dims.width,g.dims.height):void 0,h.drawImage(b,g.dims.left,g.dims.top),T=h.getImageData(0,0,o,u),c.push(T),1===g.disposalType||(2===g.disposalType?h.clearRect(g.dims.left,g.dims.top,g.dims.width,g.dims.height):3===g.disposalType&&h.putImageData(y,g.dims.left,g.dims.top))}catch(r){_.e(r)}finally{_.f()}return e.abrupt("return",{frameDurations:d,getFrame:function(e){return c[e]},width:o,height:u});case 6:case"end":return e.stop()}}),e)}))),B.apply(this,arguments)}var E=[71,73,70];function O(e){if(!function(e){var t=new Uint8Array(e);return!E.some((function(e,r){return e!==t[r]}))}(e))return!1;for(var t=new DataView(e),r=t.getUint8(10),i=13+(128&r?3*Math.pow(2,1+(7&r)):0),n=0,s=!1;!s;){switch(t.getUint8(i++)){case 33:if(!a())return!1;break;case 44:o();break;case 59:s=!0;break;default:return!1}if(n>1)return!0}function a(){switch(t.getUint8(i++)){case 249:i++,i+=4,u();break;case 1:n++,i++,i+=12,u();break;case 254:u();break;case 255:i++,i+=8,i+=3,u();break;default:return!1}return!0}function o(){n++,i+=8;var e=t.getUint8(i++);i+=128&e?3*Math.pow(2,1+(7&e)):0,i++,u()}function u(){for(var e;e=t.getUint8(i++);)i+=e}return!1}var k=function(){function e(){(0,a.Z)(this,e),this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}return(0,o.Z)(e,[{key:"destroy",value:function(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}},{key:"getResource",value:function(e){var t;return null!==(t=this._resourceMap.get(e))&&void 0!==t?t:null}},{key:"fetchResource",value:function(){var e=(0,s.Z)((0,n.Z)().mark((function e(t,r){var i,s,a=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=this._resourceMap.get(t))){e.next=3;break}return e.abrupt("return",{width:i.width,height:i.height});case 3:return s=this._inFlightResourceMap.get(t),e.abrupt("return",s?s.then((function(e){return{width:e.width,height:e.height}})):(s=R(t,r),this._inFlightResourceMap.set(t,s),s.then((function(e){return a._inFlightResourceMap.delete(t),a._resourceMap.set(t,e),{width:e.width,height:e.height}}),(function(){return{width:0,height:0}}))));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"deleteResource",value:function(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}},{key:"loadFont",value:function(e){return(0,h.mx)(e)}}]),e}();function F(e,t){return M.apply(this,arguments)}function M(){return M=(0,s.Z)((0,n.Z)().mark((function e(t,r){var s,a,o;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=window.URL.createObjectURL(t),e.prev=1,e.next=4,(0,u.default)(s,(0,i.Z)((0,i.Z)({},r),{},{responseType:"image"}));case 4:return a=e.sent,o=a.data,e.abrupt("return",o);case 9:if(e.prev=9,e.t0=e.catch(1),(0,c.D_)(e.t0)){e.next=13;break}throw new l.Z("mapview-invalid-resource","Could not fetch requested resource at ".concat(s));case 13:throw e.t0;case 14:return e.prev=14,window.URL.revokeObjectURL(s),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[1,9,14,17]])}))),M.apply(this,arguments)}function R(e,t){return P.apply(this,arguments)}function P(){return P=(0,s.Z)((0,n.Z)().mark((function e(t,r){var i,s,a,o;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C(t,r);case 2:if(i=e.sent,s=i.arrayBuffer,a=i.mediaType,o="image/png"===a,"image/gif"!==a||!O(s)){e.next=8;break}return e.abrupt("return",T(s));case 8:if(!o||!y(s)){e.next=10;break}return e.abrupt("return",v(s,r));case 10:return e.abrupt("return",F(new Blob([s],{type:a}),r));case 11:case"end":return e.stop()}}),e)}))),P.apply(this,arguments)}function C(e,t){return A.apply(this,arguments)}function A(){return A=(0,s.Z)((0,n.Z)().mark((function e(t,r){var s,a,o,h,f,_,p;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=";base64,",!t.includes(a)){e.next=6;break}o=t.indexOf(a),h=t.indexOf(a)+8,f=t.substring(h),s={arrayBuffer:(0,d.R)(f),mediaType:t.substring(0,o).replace("data:","")},e.next=18;break;case 6:return e.prev=6,e.next=9,(0,u.default)(t,(0,i.Z)({responseType:"array-buffer"},r));case 9:_=e.sent,p=_.data,s={arrayBuffer:p,mediaType:_.getHeader("Content-Type")},e.next=18;break;case 14:if(e.prev=14,e.t0=e.catch(6),(0,c.D_)(e.t0)){e.next=18;break}throw new l.Z("mapview-invalid-resource","Could not fetch requested resource at ".concat(t));case 18:return e.abrupt("return",s);case 19:case"end":return e.stop()}}),e,null,[[6,14]])}))),A.apply(this,arguments)}},8499:function(e,t,r){r.r(t),r.d(t,{GraphicContainer:function(){return ht.Z},GraphicsView2D:function(){return lt.Z},LabelManager:function(){return ut.Q},MagnifierView2D:function(){return Tt},MapViewNavigation:function(){return ct.Z},Stage:function(){return ot}});var i=r(74165),n=r(1413),s=r(15861),a=r(37762),o=r(15671),u=r(43144),l=r(97326),h=r(11752),c=r(61120),d=r(60136),f=r(29388),_=r(10064),p=r(98928),v=r(93169),g=r(92026),m=r(99346),b=r(23588),y=r(17653),w=r(33624),x=r(39484),T=r(80613),B=r(62272),E=r(10106),O=r(34052),k=r(65706),F=function(e){return(0,k.K)({ID:e.id,PATTERN:e.pattern})},M={shaders:function(e){return{vertexShader:F(e)+(0,O.w)("background/background.vert"),fragmentShader:F(e)+(0,O.w)("background/background.frag")}}},R=function(e){return(0,k.K)({ID:e.id})},P={shaders:function(e){return{vertexShader:R(e)+(0,O.w)("circle/circle.vert"),fragmentShader:R(e)+(0,O.w)("circle/circle.frag")}}},C=function(e){return(0,k.K)({ID:e.id,PATTERN:e.pattern})},A={shaders:function(e){return{vertexShader:C(e)+(0,O.w)("fill/fill.vert"),fragmentShader:C(e)+(0,O.w)("fill/fill.frag")}}},S=function(e){return(0,k.K)({ID:e.id})},Z={shaders:function(e){return{vertexShader:S(e)+(0,O.w)("outline/outline.vert"),fragmentShader:S(e)+(0,O.w)("outline/outline.frag")}}},U=function(e){return(0,k.K)({ID:e.id,SDF:e.sdf})},z={shaders:function(e){return{vertexShader:U(e)+(0,O.w)("icon/icon.vert"),fragmentShader:U(e)+(0,O.w)("icon/icon.frag")}}},D=function(e){return(0,k.K)({ID:e.id,PATTERN:e.pattern,SDF:e.sdf})},I={shaders:function(e){return{vertexShader:D(e)+(0,O.w)("line/line.vert"),fragmentShader:D(e)+(0,O.w)("line/line.frag")}}},L=function(e){return(0,k.K)({ID:e.id})},N={shaders:function(e){return{vertexShader:L(e)+(0,O.w)("text/text.vert"),fragmentShader:L(e)+(0,O.w)("text/text.frag")}}},q=function(){function e(){(0,o.Z)(this,e),this._programByKey=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getMaterialProgram",value:function(e,t,r){var i=t.key<<3|this._getMaterialOptionsValue(t.type,r);if(this._programByKey.has(i))return this._programByKey.get(i);var n=(0,this._getProgramTemplate(t.type).shaders)(r),s=n.vertexShader,a=n.fragmentShader,o=t.getShaderHeader(),u=t.getShaderMain(),l=s.replace("#pragma header",o).replace("#pragma main",u),h=e.programCache.acquire(l,a,t.getAttributeLocations());return this._programByKey.set(i,h),h}},{key:"_getMaterialOptionsValue",value:function(e,t){switch(e){case E._K.BACKGROUND:var r=t;return(r.pattern?1:0)<<1|(r.id?1:0);case E._K.FILL:var i=t;return(i.pattern?1:0)<<1|(i.id?1:0);case E._K.OUTLINE:return t.id?1:0;case E._K.LINE:var n=t;return(n.sdf?1:0)<<2|(n.pattern?1:0)<<1|(n.id?1:0);case E._K.ICON:var s=t;return(s.sdf?1:0)<<1|(s.id?1:0);case E._K.CIRCLE:case E._K.TEXT:return t.id?1:0;default:return 0}}},{key:"_getProgramTemplate",value:function(e){switch(e){case E._K.BACKGROUND:return M;case E._K.CIRCLE:return P;case E._K.FILL:return A;case E._K.ICON:return z;case E._K.LINE:return I;case E._K.OUTLINE:return Z;case E._K.TEXT:return N;default:return null}}}]),e}(),H=r(61441),G=r(53456),V=r(44070),W=r(8548),j=r(96721),K=r(45412),X=function(){function e(){(0,o.Z)(this,e),this._initialized=!1}return(0,u.Z)(e,[{key:"dispose",value:function(){this._program=(0,g.M2)(this._program),this._vertexArrayObject=(0,g.M2)(this._vertexArrayObject)}},{key:"render",value:function(e,t,r,i){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(r),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",i),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}},{key:"_initialize",value:function(e){if(this._initialized)return!0;var t=(0,j.H)(e,G.Q);if(!t)return!1;var r=new Int8Array(16);r[0]=-1,r[1]=-1,r[2]=0,r[3]=0,r[4]=1,r[5]=-1,r[6]=1,r[7]=0,r[8]=-1,r[9]=1,r[10]=0,r[11]=1,r[12]=1,r[13]=1,r[14]=1,r[15]=1;var i=G.Q.attributes,n=new K.U(e,i,H.As,{geometry:V.f.createVertex(e,W.l1.STATIC_DRAW,r)});return this._program=t,this._vertexArrayObject=n,this._initialized=!0,!0}}]),e}(),Q=r(4942),Y=r(40658),J=function(e){return e===T.jx.HITTEST||e===T.jx.LABEL_ALPHA},$=function(e,t,r){var i=e.rendererInfo,n=e.drawPhase;return"".concat(t.getVariationHash(),"-").concat(function(e){return(J(e)?1:0)|(e===T.jx.HIGHLIGHT?2:0)}(n),"-").concat(i.getVariationHash(),"-").concat(null!=r&&r.join("."))},ee=function(){function e(t){(0,o.Z)(this,e),this._rctx=t,this._programByKey=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getProgram",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=e.vsPath+"."+e.fsPath+JSON.stringify(t);if(this._programByKey.has(r))return this._programByKey.get(r);var i=(0,n.Z)({},t.map((function(e){return"string"==typeof e?{name:e,value:!0}:e})).reduce((function(e,t){return(0,n.Z)((0,n.Z)({},e),{},(0,Q.Z)({},t.name,t.value))}),{})),s=e.vsPath,a=e.fsPath,o=e.attributes,u=(0,Y.s)(s,a,o,i),l=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(r,l),l}},{key:"getMaterialProgram",value:function(e,t,r,i,s){var o=$(e,t,s);if(this._programByKey.has(o))return this._programByKey.get(o);var u=function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(i=(0,n.Z)((0,n.Z)((0,n.Z)((0,n.Z)({},i),t.getVariation()),e.rendererInfo.getVariation()),{},{highlight:e.drawPhase===T.jx.HIGHLIGHT,id:J(e.drawPhase)}),null!=r){var s,o=(0,a.Z)(r);try{for(o.s();!(s=o.n()).done;)i[s.value]=!0}catch(u){o.e(u)}finally{o.f()}}return i}(e,t,s,{ignoresSamplerPrecision:e.context.driverTest.ignoresSamplerPrecision.result}),l=(0,Y.s)(r,r,i,u),h=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,h),h}}]),e}(),te=r(62013),re=r(66978),ie=r(94109),ne=r(83826),se=function(){function e(t,r){(0,o.Z)(this,e),this._queue=[],this._context=t,this._refreshable=r}return(0,u.Z)(e,[{key:"destroy",value:function(){this._queue=[]}},{key:"enqueueTextureUpdate",value:function(e,t){var r=(0,re.hh)(),i=e,n=ie.u4,s=Math.ceil(i.height/n);if((0,re.k_)(t),this._context.type===ne.zO.WEBGL1)this._queue.push({type:"no-chunk",request:e,resolver:r,options:t});else for(var a=0;a<s;a++){var o=a*n,u=a===s-1,l=u?i.height-n*a:n;this._queue.push({type:"chunk",request:e,resolver:r,chunk:a,chunkOffset:o,destHeight:l,chunkIsLast:u,options:t})}return(0,re.$F)(t,(function(e){return r.reject(e)})),r.promise}},{key:"upload",value:function(){for(var e=0;this._queue.length;){var t=performance.now(),r=this._queue.shift();if(r){if(null!=r.options.signal&&r.options.signal.aborted)continue;switch(r.type){case"chunk":this._uploadChunk(r);break;case"no-chunk":this._uploadNoChunk(r)}var i=performance.now()-t;if((e+=i)+i>=ie.nb)break}}this._queue.length&&this._refreshable.requestRender()}},{key:"_uploadChunk",value:function(e){var t=e.request,r=e.resolver,i=e.chunkOffset,n=e.chunkIsLast,s=e.destHeight,a=t.data,o=t.texture,u=t.width;null!=a&&(o.updateData(0,0,i,u,s,a,i),n&&r.resolve())}},{key:"_uploadNoChunk",value:function(e){var t=e.request,r=e.resolver,i=t.data;t.texture.setData(i),r.resolve()}}]),e}(),ae=r(26277),oe=r(22753),ue=r(6394),le=r(11186),he=r(71353),ce=r(25866),de=r(92841),fe=(0,ue.f)(-.5,-.5),_e=function(){function e(){(0,o.Z)(this,e),this._centerNdc=(0,he.c)(),this._pxToNdc=(0,he.c)(),this._worldDimensionsPx=(0,he.c)(),this._mat3=(0,b.c)(),this._initialized=!1}return(0,u.Z)(e,[{key:"dispose",value:function(){this._program=(0,g.M2)(this._program),this._quad=(0,g.M2)(this._quad)}},{key:"render",value:function(e,t){var r=e.context;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(r),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setColorMask(!1,!1,!1,!1),r.setBlendingEnabled(!1),r.setStencilOp(W.xS.KEEP,W.xS.KEEP,W.xS.REPLACE),r.setStencilFunction(W.wb.ALWAYS,1,255),r.setStencilTestEnabled(!0),r.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}},{key:"_initialize",value:function(e){if(!this._initialized){var t=(0,j.H)(e,de.H);t&&(this._program=t,this._quad=new ce.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}}},{key:"_updateGeometry",value:function(e,t){var r=e.state,i=e.pixelRatio,n=r.size,s=r.rotation,a=Math.round(n[0]*i),o=Math.round(n[1]*i);if(!r.spatialReference.isWrappable)return!1;var u=(0,ae.t)(s),l=Math.abs(Math.cos(u)),h=Math.abs(Math.sin(u)),c=Math.round(a*l+o*h),d=Math.round(r.worldScreenWidth);if(c<=d)return!1;var f=a*h+o*l,_=d*i,p=(t.left-t.right)*i/a,v=(t.bottom-t.top)*i/o;(0,le.s)(this._worldDimensionsPx,_,f,1),(0,le.s)(this._pxToNdc,2/a,-2/o,1),(0,le.s)(this._centerNdc,p,v,1);var g=this._mat3;return(0,oe.k)(g,this._centerNdc),(0,oe.d)(g,g,this._pxToNdc),0!==s&&(0,oe.r)(g,g,u),(0,oe.d)(g,g,this._worldDimensionsPx),(0,oe.h)(g,g,fe),!0}}]),e}(),pe=r(93879),ve=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).defines=[],e._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])},e}return(0,u.Z)(r,[{key:"dispose",value:function(){this._quad&&this._quad.dispose()}},{key:"bind",value:function(){}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){if(null!==t&&void 0!==t&&t.size){var r=e.context,i=e.renderingOptions;this._quad||(this._quad=new ce.Z(r,[0,0,1,0,0,1,1,1]));var n=r.getBoundFramebufferObject(),s=r.getViewport(),a=s.x,o=s.y,u=s.width,l=s.height;t.bindTextures(r);var h=t.getBlock(ie.xl);if(null!=h){var c=h.getFBO(r),d=h.getFBO(r,1);r.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,i.labelsAnimationTime),this._updateAnimationState(e,d,c),r.bindFramebuffer(n),r.setViewport(a,o,u,l)}}}},{key:"_computeDelta",value:function(e,t,r){var i=e.context,n=e.painter,s=e.displayLevel,a=n.materialManager.getProgram(this._desc,["delta"]);i.bindFramebuffer(t),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),i.useProgram(a);var o=(0,v.Z)("featurelayer-animation-enabled")?r:1;a.setUniform1i("u_maskTexture",ie.iJ),a.setUniform1i("u_sourceTexture",ie.nM),a.setUniform1f("u_timeDelta",e.deltaTime),a.setUniform1f("u_animationTime",o),a.setUniform1f("u_zoomLevel",Math.round(10*s)),this._quad.draw()}},{key:"_updateAnimationState",value:function(e,t,r){var i=e.context,n=e.painter.materialManager.getProgram(this._desc,["update"]);i.bindTexture(t.colorTexture,1),i.useProgram(n),n.setUniform1i("u_sourceTexture",1),i.bindFramebuffer(r),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._quad.draw()}}]),r}(pe.Q),ge=r(23174),me=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(e){var i;return(0,o.Z)(this,r),(i=t.call(this)).name=i.constructor.name,i.defines=[e],i}return(0,u.Z)(r,[{key:"dispose",value:function(){}},{key:"bind",value:function(e){var t=e.context,r=e.painter;this._prev=t.getBoundFramebufferObject();var i=t.getViewport(),n=i.width,s=i.height,a=r.getFbos(n,s).effect0;t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var r,i=e.context,n=e.painter,s=n.getPostProcessingEffects(t),o=i.getBoundFramebufferObject(),u=(0,a.Z)(s);try{for(u.s();!(r=u.n()).done;){var l=r.value,h=l.postProcessingEffect,c=l.effect;h.draw(e,o,c)}}catch(d){u.e(d)}finally{u.f()}i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),n.blitTexture(i,o.colorTexture,W.cw.NEAREST),i.setStencilTestEnabled(!0)}}]),r}(pe.Q),be=r(17615),ye=r(93985),we=r(61109),xe=function(){function e(){(0,o.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}},{key:"preBlur",value:function(e,t){e.bindTexture(t,ie.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",be.n5),e.bindVAO(this._resources.quadVAO),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"finalBlur",value:function(e,t){e.bindTexture(t,ie.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",be.QU),e.bindVAO(this._resources.quadVAO),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"renderHighlight",value:function(e,t,r){e.bindTexture(t,ie.QU),e.useProgram(this._resources.highlightProgram),r.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(W.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"_initialize",value:function(e,t,r){this._width=t,this._height=r;var i=V.f.createVertex(e,W.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new K.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new we.G("a_position",2,W.g.BYTE,0,4),new we.G("a_texcoord",2,W.g.UNSIGNED_BYTE,2,4)]},{geometry:i}),s=(0,j.H)(e,ye.C),a=(0,j.H)(e,ye.y);e.useProgram(s),s.setUniform1i("u_texture",ie.QU),s.setUniform1i("u_shade",ie.Jw),s.setUniform1f("u_sigma",be.tM),e.useProgram(a),a.setUniform1i("u_texture",ie.QU),a.setUniform1f("u_sigma",be.tM),this._resources={quadGeometry:i,quadVAO:n,highlightProgram:s,blurProgram:a}}},{key:"setup",value:function(e,t,r){this._resources?(this._width=t,this._height=r):this._initialize(e,t,r)}}]),e}(),Te=r(53634),Be=r(3479),Ee=r(52311);function Oe(e,t,r){var i=new Ee.X(t,r);return i.wrapMode=W.e8.CLAMP_TO_EDGE,new Te.X(e,i,new Be.Y(W.Tg.STENCIL_INDEX8,t,r))}var ke=function(){function e(){(0,o.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=(0,g.wN)(this._resources))}},{key:"_initialize",value:function(e,t,r){this._width=t,this._height=r;var i=Oe(e,t,r),n=Oe(e,t,r);this._resources={sharedBlur1Fbo:i,sharedBlur2Fbo:n}}},{key:"setup",value:function(e,t,r){!this._resources||this._width===t&&this._height===r||this.dispose(),this._resources||this._initialize(e,t,r)}},{key:"sharedBlur1Tex",get:function(){return this._resources.sharedBlur1Fbo.colorTexture}},{key:"sharedBlur1Fbo",get:function(){return this._resources.sharedBlur1Fbo}},{key:"sharedBlur2Tex",get:function(){return this._resources.sharedBlur2Fbo.colorTexture}},{key:"sharedBlur2Fbo",get:function(){return this._resources.sharedBlur2Fbo}}]),e}(),Fe=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).defines=["highlight"],e._hlRenderer=new xe,e._width=void 0,e._height=void 0,e._boundFBO=null,e._hlSurfaces=new ke,e._adjustedWidth=void 0,e._adjustedHeight=void 0,e._blitRenderer=new X,e}return(0,u.Z)(r,[{key:"dispose",value:function(){var e,t;null!==(e=this._hlSurfaces)&&void 0!==e&&e.dispose(),null!==(t=this._hlRenderer)&&void 0!==t&&t.dispose(),this._boundFBO=null}},{key:"bind",value:function(e){var t=e.context,r=e.painter,i=t.getViewport(),n=i.width,s=i.height,a=r.getFbos(n,s).effect0;this.setup(e,n,s),t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"setup",value:function(e,t,r){var i=e.context;this._width=t,this._height=r;var n=t%4,s=r%4;t+=n<2?-n:4-n,r+=s<2?-s:4-s,this._adjustedWidth=t,this._adjustedHeight=r,this._boundFBO=i.getBoundFramebufferObject();var a=Math.round(1*t),o=Math.round(1*r);this._hlRenderer.setup(i,a,o),this._hlSurfaces.setup(i,a,o)}},{key:"draw",value:function(e){var t=e.context,r=e.highlightGradient;if(r){var i=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,i.colorTexture,W.cw.NEAREST,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,r),this._boundFBO=null}}}]),r}(pe.Q),Me=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["hittest"],e}return(0,u.Z)(r,[{key:"dispose",value:function(){null!=this._fbo&&this._fbo.dispose()}},{key:"createOptions",value:function(e,t){var r=e.pixelRatio,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ie.dn;if(!t.length)return null;var n=t.shift(),s=n.x,a=n.y;return this._outstanding=n,{type:"hittest",distance:i*r,position:[s,a]}}},{key:"bind",value:function(e){var t=e.context,r=e.attributeView;if(r.size){var i=r.getBlock(ie.pU);if(null!=i){var n=i.getFBO(t);t.setViewport(0,0,r.size,r.size),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}}}},{key:"unbind",value:function(e){}},{key:"draw",value:function(e){if(null!=this._outstanding){var t=this._outstanding;this._outstanding=null,this._resolve(e,t.resolvers)}}},{key:"_resolve",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r){var n,s,a,o,u,l,h,c,d,f;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.context,s=t.attributeView,null!=(a=s.getBlock(ie.pU))){e.next=3;break}return e.abrupt("return",void r.forEach((function(e){return e.resolve([])})));case 3:return o=a.getFBO(n),u=new Uint8Array(o.width*o.height*4),e.prev=4,e.next=7,o.readPixelsAsync(0,0,o.width,o.height,W.VI.RGBA,W.Br.UNSIGNED_BYTE,u);case 7:e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(4),e.abrupt("return",void r.forEach((function(e){return e.resolve([])})));case 12:for(l=[],h=0;h<u.length;h+=4)c=u[h],d=u[h+3],c&&l.push({id:h/4,directHits:d});l.sort((function(e,t){return t.directHits===e.directHits?t.id-e.id:t.directHits-e.directHits})),f=l.map((function(e){return e.id})),r.forEach((function(e){return e.resolve(f)}));case 17:case"end":return e.stop()}}),e,null,[[4,9]])})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(pe.Q),Re=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e._boundFBO=null,e}return(0,u.Z)(r,[{key:"dispose",value:function(){null!=this._fbo&&this._fbo.dispose()}},{key:"bind",value:function(e){var t=e.context,r=e.painter,i=t.getViewport(),n=i.width,s=i.height;this._boundFBO=t.getBoundFramebufferObject();var a=r.getFbos(n,s).effect0;t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(e){e.context.bindFramebuffer(this._boundFBO),this._boundFBO=null}},{key:"draw",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*ie.dn;this._resolve(e,t,r)}},{key:"_resolve",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r,n){var a,o,u,l,h,c,d,f,_=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.context,o=t.state,u=t.pixelRatio,l=a.getBoundFramebufferObject(),h=o.size[1]*u,c=Math.round(n*u),d=c/2,f=c/2,this._ensureBuffer(c),r.forEach(function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,n){var s,a,o,p,v,g,m,b,y,w;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=new Map,a=Math.floor(n.x*u-c/2),o=Math.floor(h-n.y*u-c/2),e.next=3,l.readPixelsAsync(a,o,c,c,W.VI.RGBA,W.Br.UNSIGNED_BYTE,_._buf);case 3:for(p=0;p<_._buf32.length;p++)4294967295!==(v=_._buf32[p])&&0!==v&&(g=p%c,m=c-Math.floor(p/c),b=(d-g)*(d-g)+(f-m)*(f-m),y=s.has(v)?s.get(v):4294967295,s.set(v,Math.min(b,y)));w=Array.from(s).sort((function(e,t){return e[1]-t[1]})).map((function(e){return e[0]})),t.resolve(w),r.delete(n);case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_ensureBuffer",value:function(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}]),r}(pe.Q),Pe=[1,0],Ce=[0,1],Ae=[1,.8,.6,.4,.2],Se=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],Ze=function(){function e(){(0,o.Z)(this,e),this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){if(this._quad=(0,g.M2)(this._quad),this._intensityFBO=(0,g.M2)(this._intensityFBO),this._compositeFBO=(0,g.M2)(this._compositeFBO),this._mipsFBOs){for(var e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height,s=e.context,a=e.painter.materialManager,o=s.gl,u=this._programDesc,l=r.strength,h=r.radius,c=r.threshold;this._quad||(this._quad=new ce.Z(s,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,i,n),s.setStencilTestEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),s.setStencilWriteMask(0);var d=this._quad;d.bind(),s.bindFramebuffer(this._intensityFBO);var f=a.getProgram(u.luminosityHighPass);s.useProgram(f),s.bindTexture(t.colorTexture,0),f.setUniform1i("u_texture",0),f.setUniform3fv("u_defaultColor",[0,0,0]),f.setUniform1f("u_defaultOpacity",0),f.setUniform1f("u_luminosityThreshold",c),f.setUniform1f("u_smoothWidth",.01);var _=[Math.round(i/2),Math.round(n/2)];s.setViewport(0,0,_[0],_[1]),s.setClearColor(0,0,0,0),s.clear(o.COLOR_BUFFER_BIT),d.draw(),s.setBlendingEnabled(!1);for(var p=this._intensityFBO.colorTexture,v=0;v<this._nMips;v++){var g=a.getProgram(u.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[v]}]);s.useProgram(g),s.bindTexture(p,v+1),g.setUniform1i("u_colorTexture",v+1),g.setUniform2fv("u_texSize",_),g.setUniform2fv("u_direction",Pe),s.setViewport(0,0,_[0],_[1]);var m=this._mipsFBOs[v];s.bindFramebuffer(m.horizontal),d.draw(),p=m.horizontal.colorTexture,s.bindFramebuffer(m.vertical),s.bindTexture(p,v+1),g.setUniform2fv("u_direction",Ce),d.draw(),p=m.vertical.colorTexture,_[0]=Math.round(_[0]/2),_[1]=Math.round(_[1]/2)}s.setViewport(0,0,i,n);var b=a.getProgram(u.composite,[{name:"nummips",value:5}]);s.bindFramebuffer(this._compositeFBO),s.useProgram(b),b.setUniform1f("u_bloomStrength",l),b.setUniform1f("u_bloomRadius",h),b.setUniform1fv("u_bloomFactors",Ae),b.setUniform3fv("u_bloomTintColors",Se),s.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),b.setUniform1i("u_blurTexture1",1),s.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),b.setUniform1i("u_blurTexture2",2),s.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),b.setUniform1i("u_blurTexture3",3),s.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),b.setUniform1i("u_blurTexture4",4),s.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),b.setUniform1i("u_blurTexture5",5),d.draw(),s.bindFramebuffer(t),s.setBlendingEnabled(!0);var y=a.getProgram(u.blit);s.useProgram(y),s.bindTexture(this._compositeFBO.colorTexture,6),y.setUniform1i("u_texture",6),s.setBlendFunction(W.zi.ONE,W.zi.ONE),d.draw(),d.unbind(),s.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._compositeFBO||this._size[0]!==t||this._size[1]!==r){this._size[0]=t,this._size[1]=r;var n=[Math.round(t/2),Math.round(r/2)];if(this._compositeFBO)this._compositeFBO.resize(t,r);else{var s=new Ee.X(t,r);s.internalFormat=W.VI.RGBA,s.wrapMode=W.e8.CLAMP_TO_EDGE,this._compositeFBO=new Te.X(i,s)}if(this._intensityFBO)this._intensityFBO.resize(n[0],n[1]);else{var a=new Ee.X(n[0],n[1]);a.internalFormat=W.VI.RGBA,a.wrapMode=W.e8.CLAMP_TO_EDGE,this._intensityFBO=new Te.X(i,a)}for(var o=0;o<this._nMips;o++){if(this._mipsFBOs[o])this._mipsFBOs[o].horizontal.resize(n[0],n[1]),this._mipsFBOs[o].vertical.resize(n[0],n[1]);else{var u=new Ee.X(n[0],n[1]);u.internalFormat=W.VI.RGBA,u.wrapMode=W.e8.CLAMP_TO_EDGE,this._mipsFBOs[o]={horizontal:new Te.X(i,u),vertical:new Te.X(i,u)}}n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}}]),e}(),Ue=[1,0],ze=[0,1],De=function(){function e(){(0,o.Z)(this,e),this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}},{key:"draw",value:function(e,t,r){var i=e.context,n=r.type,s=r.radius;if(0!==s){this._createOrResizeResources(e),this._quad||(this._quad=new ce.Z(i,[-1,-1,1,-1,-1,1,1,1]));var a=this._quad;a.bind(),"blur"===n?this._gaussianBlur(e,t,s):this._radialBlur(e,t),a.unbind()}}},{key:"_gaussianBlur",value:function(e,t,r){var i=e.context,n=e.state,s=e.painter,a=e.pixelRatio,o=n.size,u=s.materialManager,l=this._programDesc,h=this._quad,c=[Math.round(a*o[0]),Math.round(a*o[1])],d=this._blurFBO,f=u.getProgram(l.gaussianBlur,[{name:"radius",value:Math.ceil(r)}]);i.useProgram(f),i.setBlendingEnabled(!1),i.bindFramebuffer(d),i.bindTexture(t.colorTexture,4),f.setUniform1i("u_colorTexture",4),f.setUniform2fv("u_texSize",c),f.setUniform2fv("u_direction",Ue),f.setUniform1f("u_sigma",r),h.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.bindTexture(null===d||void 0===d?void 0:d.colorTexture,5),f.setUniform1i("u_colorTexture",5),f.setUniform2fv("u_direction",ze),h.draw(),i.setBlendingEnabled(!0),i.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),i.setStencilTestEnabled(!0)}},{key:"_radialBlur",value:function(e,t){var r=e.context,i=e.painter.materialManager,n=this._programDesc,s=this._quad,a=this._blurFBO;r.bindFramebuffer(a);var o=i.getProgram(n.radialBlur);r.useProgram(o),r.setBlendingEnabled(!1),r.bindTexture(t.colorTexture,4),o.setUniform1i("u_colorTexture",4),s.draw(),r.bindFramebuffer(t),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setBlendingEnabled(!0);var u=i.getProgram(n.blit);r.useProgram(u),r.bindTexture(null===a||void 0===a?void 0:a.colorTexture,5),u.setUniform1i("u_texture",5),r.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),s.draw()}},{key:"_createOrResizeResources",value:function(e){var t=e.context,r=e.state,i=e.pixelRatio,n=r.size,s=Math.round(i*n[0]),a=Math.round(i*n[1]);if(!this._blurFBO||this._size[0]!==s||this._size[1]!==a)if(this._size[0]=s,this._size[1]=a,this._blurFBO)this._blurFBO.resize(s,a);else{var o=new Ee.X(s,a);o.internalFormat=W.VI.RGBA,o.wrapMode=W.e8.CLAMP_TO_EDGE,this._blurFBO=new Te.X(t,o)}}}]),e}(),Ie=r(57808),Le=function(){function e(){(0,o.Z)(this,e),this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,g.M2)(this._layerFBOTexture)}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height;this._createOrResizeResources(e,i,n);var s=e.context,a=e.painter.materialManager,o=this._programDesc,u=this._quad,l=r.colorMatrix;u.bind();var h=this._layerFBOTexture;s.bindFramebuffer(t),t.copyToTexture(0,0,i,n,0,0,h),s.setBlendingEnabled(!1),s.setStencilTestEnabled(!1);var c=a.getProgram(o);s.useProgram(c),s.bindTexture(h,2),c.setUniformMatrix4fv("u_coefficients",l),c.setUniform1i("u_colorTexture",2),u.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0),u.unbind()}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._layerFBOTexture||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{var n=new Ee.X;n.internalFormat=W.VI.RGBA,n.wrapMode=W.e8.CLAMP_TO_EDGE,n.width=t,n.height=r,this._layerFBOTexture=new Ie.x(i,n)}this._quad||(this._quad=new ce.Z(i,[-1,-1,1,-1,-1,1,1,1]))}}}]),e}(),Ne=r(17842),qe=[1,0],He=[0,1],Ge=function(){function e(){(0,o.Z)(this,e),this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,g.M2)(this._layerFBOTexture),this._horizontalBlurFBO=(0,g.M2)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,g.M2)(this._verticalBlurFBO)}},{key:"draw",value:function(e,t,r){var i=e.context,n=e.state,s=e.painter.materialManager,a=this._programDesc,o=t.width,u=t.height,l=[Math.round(o),Math.round(u)],h=r.blurRadius,c=r.offsetX,d=r.offsetY,f=r.color,_=[(0,Ne.F2)(c),(0,Ne.F2)(d)];this._createOrResizeResources(e,o,u,l);var p=this._horizontalBlurFBO,v=this._verticalBlurFBO;i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1);var g=this._layerFBOTexture;t.copyToTexture(0,0,o,u,0,0,g),this._quad||(this._quad=new ce.Z(i,[-1,-1,1,-1,-1,1,1,1])),i.setViewport(0,0,l[0],l[1]);var m=this._quad;m.bind(),i.setBlendingEnabled(!1);var b=s.getProgram(a.blur,[{name:"radius",value:Math.ceil(h)}]);i.useProgram(b),i.bindFramebuffer(p),i.bindTexture(t.colorTexture,4),b.setUniform1i("u_colorTexture",4),b.setUniform2fv("u_texSize",l),b.setUniform2fv("u_direction",qe),b.setUniform1f("u_sigma",h),m.draw(),i.bindFramebuffer(v),i.bindTexture(null===p||void 0===p?void 0:p.colorTexture,5),b.setUniform1i("u_colorTexture",5),b.setUniform2fv("u_direction",He),m.draw(),i.bindFramebuffer(t),i.setViewport(0,0,o,u);var y=s.getProgram(a.composite);i.useProgram(y),i.bindTexture(null===v||void 0===v?void 0:v.colorTexture,2),y.setUniform1i("u_blurTexture",2),i.bindTexture(g,3),y.setUniform1i("u_layerFBOTexture",3),y.setUniform4fv("u_shadowColor",[f[3]*(f[0]/255),f[3]*(f[1]/255),f[3]*(f[2]/255),f[3]]),y.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),y.setUniform2fv("u_shadowOffset",_),m.draw(),i.setBlendingEnabled(!0),i.setStencilTestEnabled(!0),i.setBlendFunction(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),m.unbind()}},{key:"_createOrResizeResources",value:function(e,t,r,i){var n=e.context;if(!this._horizontalBlurFBO||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(i[0],i[1]);else{var s=new Ee.X(i[0],i[1]);s.internalFormat=W.VI.RGBA,s.wrapMode=W.e8.CLAMP_TO_EDGE,this._horizontalBlurFBO=new Te.X(n,s)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(i[0],i[1]);else{var a=new Ee.X(i[0],i[1]);a.internalFormat=W.VI.RGBA,a.wrapMode=W.e8.CLAMP_TO_EDGE,this._verticalBlurFBO=new Te.X(n,a)}if(this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{var o=new Ee.X;o.internalFormat=W.VI.RGBA,o.wrapMode=W.e8.CLAMP_TO_EDGE,o.width=t,o.height=r,this._layerFBOTexture=new Ie.x(n,o)}}}}]),e}(),Ve=function(){function e(){(0,o.Z)(this,e),this._size=[0,0],this._layerFBOTexture=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,g.M2)(this._layerFBOTexture)}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height;this._createOrResizeResources(e,i,n);var s=e.context,a=e.painter,o=r.amount,u=s.gl,l=this._layerFBOTexture;s.bindFramebuffer(t),t.copyToTexture(0,0,i,n,0,0,l),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!1),s.setDepthTestEnabled(!1),s.setClearColor(0,0,0,0),s.clear(u.COLOR_BUFFER_BIT),a.blitTexture(s,l,W.cw.NEAREST,o)}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._layerFBOTexture||this._size[0]!==t||this._size[1]!==r)if(this._size[0]=t,this._size[1]=r,this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{var n=new Ee.X;n.internalFormat=W.VI.RGBA,n.wrapMode=W.e8.CLAMP_TO_EDGE,n.samplingMode=W.cw.NEAREST,n.width=t,n.height=r,this._layerFBOTexture=new Ie.x(i,n)}}}]),e}();function We(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}var je={colorize:function(){return new Le},blur:function(){return new De},bloom:function(){return new Ze},opacity:function(){return new Ve},"drop-shadow":function(){return new Ge}},Ke=function(){function e(){(0,o.Z)(this,e),this._effectMap=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._effectMap.forEach((function(e){return e.dispose()})),this._effectMap.clear()}},{key:"getPostProcessingEffects",value:function(e){if(!e||0===e.length)return[];var t,r=[],i=(0,a.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value,s=We(n.type),o=this._effectMap.get(s);o||(o=je[s](),this._effectMap.set(s,o)),r.push({postProcessingEffect:o,effect:n})}}catch(u){i.e(u)}finally{i.f()}return r}}]),e}(),Xe=r(29439),Qe=r(63780),Ye=function(){function e(t,r){var i;(0,o.Z)(this,e),this.brushes=t,this.name=r.name,this.drawPhase=r.drawPhase||T.jx.MAP,this._targetFn=r.target,this.effects=r.effects||[],this.enableDefaultDraw=null!==(i=r.enableDefaultDraw)&&void 0!==i?i:function(){return!0},this.forceDrawByDisplayOrder=!!r.forceDrawByDisplayOrder}return(0,u.Z)(e,[{key:"render",value:function(e){var t=e.context,r=e.profiler,i=this._targetFn(),n=this.drawPhase&e.drawPhase;if(r.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,i),r.recordPassEnd();var s,o=(0,a.Z)(this.effects);try{for(o.s();!(s=o.n()).done;){var u=s.value;if(u.enable()){var l=u.apply,h=u.args&&u.args(),c=t.getViewport(),d=t.getBoundFramebufferObject(),f=e.passOptions;this._bindEffect(e,l,h),this._doRender(e,i,l.defines),this._drawAndUnbindEffect(e,l,c,d,f,h)}}}catch(_){o.e(_)}finally{o.f()}}}},{key:"_doRender",value:function(e,t,r){if(null!=t){var i=e.profiler,n=e.context;if(this.forceDrawByDisplayOrder){var s,o=(0,a.Z)(this.brushes);try{for(o.s();!(s=o.n()).done;){var u=s.value;if(i.recordBrushStart(u.name),null!=u.brushEffect){var l=n.getViewport(),h=n.getBoundFramebufferObject(),c=e.passOptions;this._bindEffect(e,u.brushEffect),this._drawWithBrush(u,e,t,r),this._drawAndUnbindEffect(e,u.brushEffect,l,h,c)}else this._drawWithBrush(u,e,t,r);i.recordBrushEnd()}}catch(B){o.e(B)}finally{o.f()}var d=t,f=e;f.attributeView.bindTextures(e.context);var _,p=(0,a.Z)(d);try{var v=function(){var e=_.value;if(!e.visible)return 1;e.commit(f),f.context.setStencilFunction(W.wb.EQUAL,e.stencilRef,255);var t=e.getGeometry(T.LW.MARKER),i=e.getGeometry(T.LW.TEXT);if(null!=t&&t.records&&null!=i&&i.records){for(var n=new Map,s=t.records.getCursor();s.next();)n.set(s.id,[s.getDrawInfo(t,T.LW.MARKER)]);for(var o=i.records.getCursor();o.next();){var u=n.get(o.id),l=o.getDrawInfo(i,T.LW.TEXT);u?u.push(l):n.set(o.id,[l])}var h,c=Array.from(n.entries()).sort((function(e,t){var r=(0,Xe.Z)(e,2),i=r[0],n=(r[1],(0,Xe.Z)(t,2)),s=n[0];n[1];return s-i})),d=(0,a.Z)(c);try{for(d.s();!(h=d.n()).done;){var p,v=(0,Xe.Z)(h.value,2),g=(v[0],v[1]),m=(0,a.Z)(g);try{for(m.s();!(p=m.n()).done;){var b=p.value,y=f.painter.getBrush(b.geometryType,T.mD.DEFAULT);y.prepareState(f,r),y.drawGeometry(f,e,b,r)}}catch(B){m.e(B)}finally{m.f()}}}catch(B){d.e(B)}finally{d.f()}}else if(t){var w=f.painter.getBrush(T.LW.MARKER,T.mD.DEFAULT);w.prepareState(f,r),t.forEachCommand((function(t){w.drawGeometry(f,e,t,r)}))}else if(i){var x=f.painter.getBrush(T.LW.TEXT,T.mD.DEFAULT);x.prepareState(f,r),i.forEachCommand((function(t){x.drawGeometry(f,e,t,r)}))}};for(p.s();!(_=p.n()).done;)v()}catch(B){p.e(B)}finally{p.f()}}else{var g,m=(0,a.Z)(this.brushes);try{for(m.s();!(g=m.n()).done;){var b=g.value;if(i.recordBrushStart(b.name),null!=b.brushEffect){var y=n.getViewport(),w=n.getBoundFramebufferObject(),x=e.passOptions;this._bindEffect(e,b.brushEffect),this._drawWithBrush(b,e,t,r),this._drawAndUnbindEffect(e,b.brushEffect,y,w,x)}else this._drawWithBrush(b,e,t,r);i.recordBrushEnd()}}catch(B){m.e(B)}finally{m.f()}}}}},{key:"_drawWithBrush",value:function(e,t,r,i){(0,Qe.zG)(r)?(e.prepareState(t,i),e.drawMany(t,r,i)):r.visible&&(e.prepareState(t,i),e.draw(t,r,i))}},{key:"_bindEffect",value:function(e,t,r){e.profiler.recordPassStart(this.name+"."+t.name),t.bind(e,r);var i=t.createOptions(e,r);e.passOptions=i}},{key:"_drawAndUnbindEffect",value:function(e,t,r,i,n,s){var a=e.profiler,o=e.context;e.passOptions=n,a.recordBrushStart(t.name),t.draw(e,s),t.unbind(e,s),o.bindFramebuffer(i);var u=r.x,l=r.y,h=r.width,c=r.height;o.setViewport(u,l,h,c),a.recordBrushEnd(),a.recordPassEnd()}}]),e}(),Je=r(15880);var $e=function(){function e(t,r,i){(0,o.Z)(this,e),this.context=t,this._blitRenderer=new X,this._worldExtentClipRenderer=new _e,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._prevFBO=null,this._vtlMaterialManager=new q,this._blendEffect=new ge.k,this._stencilBuf=null,this._fbos=null,this._fboPool=[],this._renderTarget=null,this.effects={highlight:new Fe,hittest:new Me,hittestVTL:new Re,integrate:new ve,insideEffect:new me("inside"),outsideEffect:new me("outside")},this.materialManager=new ee(t),this.textureManager=new te.Z(r,i,t.type===ne.zO.WEBGL2),this.textureUploadManager=new se(t,r),this._effectsManager=new Ke}return(0,u.Z)(e,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}},{key:"getRenderTarget",value:function(){return this._renderTarget}},{key:"setRenderTarget",value:function(e){this._renderTarget=e}},{key:"getFbos",value:function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){var r;for(r in this._fbos)this._fbos[r].resize(e,t);return this._fbos}var i=new Ee.X(e,t);i.samplingMode=W.cw.NEAREST,i.wrapMode=W.e8.CLAMP_TO_EDGE;var n=new Be.Y(W.Tg.DEPTH_STENCIL,e,t);this._stencilBuf=new Je.r(this.context,n),this._fbos={output:new Te.X(this.context,i,this._stencilBuf),blend:new Te.X(this.context,i,this._stencilBuf),effect0:new Te.X(this.context,i,this._stencilBuf)}}return this._fbos}},{key:"acquireFbo",value:function(e,t){var r;if(this._fboPool.length>0)r=this._fboPool.pop();else{var i=new Ee.X(e,t);i.samplingMode=W.cw.NEAREST,i.wrapMode=W.e8.CLAMP_TO_EDGE,r=new Te.X(this.context,i,this._stencilBuf)}return r.width===e&&r.height===t||r.resize(e,t),r}},{key:"releaseFbo",value:function(e){this._fboPool.push(e)}},{key:"getSharedStencilBuffer",value:function(){return this._stencilBuf}},{key:"beforeRenderLayers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.getViewport(),i=r.width,n=r.height;this._prevFBO=e.getBoundFramebufferObject();var s=this.getFbos(i,n);if(e.bindFramebuffer(null===s||void 0===s?void 0:s.output),e.setColorMask(!0,!0,!0,!0),null!=t){var a=t.r,o=t.g,u=t.b,l=t.a;e.setClearColor(l*a/255,l*o/255,l*u/255,l)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}},{key:"beforeRenderLayer",value:function(e,t,r){var i,n=e.context,s=e.blendMode,a=e.effects,o=e.requireFBO,u=e.drawPhase;if(o||et(u,s,a,r))n.bindFramebuffer(null===(i=this._fbos)||void 0===i?void 0:i.blend),n.setColorMask(!0,!0,!0,!0),n.setClearColor(0,0,0,0),n.setDepthWriteEnabled(!0),n.setClearDepth(1),n.clear(n.gl.COLOR_BUFFER_BIT|n.gl.DEPTH_BUFFER_BIT),n.setDepthWriteEnabled(!1);else{var l=this._getOutputFBO();n.bindFramebuffer(l)}n.setDepthWriteEnabled(!1),n.setDepthTestEnabled(!1),n.setStencilTestEnabled(!0),n.setClearStencil(t),n.setStencilWriteMask(255),n.clear(n.gl.STENCIL_BUFFER_BIT)}},{key:"compositeLayer",value:function(e,t){var r=e.context,i=e.blendMode,n=e.effects,s=e.requireFBO,a=e.drawPhase;if(s||et(a,i,n,t)){null!=n&&n.length>0&&a===T.jx.MAP&&this._applyEffects(e,n);var o=this._getOutputFBO();r.bindFramebuffer(o),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),r.setColorMask(!0,!0,!0,!0);var u=null==i||a===T.jx.HIGHLIGHT?"normal":i,l=this._fbos;(null===l||void 0===l?void 0:l.blend.colorTexture)&&this._blendEffect.draw(e,l.blend.colorTexture,W.cw.NEAREST,u,t)}}},{key:"renderLayers",value:function(e){e.bindFramebuffer(this._prevFBO);var t=this._getOutputFBO();t&&(e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(W.wb.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,W.cw.NEAREST))}},{key:"prepareDisplay",value:function(e,t,r){var i=e.context;if(i.bindFramebuffer(this._prevFBO),i.setColorMask(!0,!0,!0,!0),null!=t){var n=t.r,s=t.g,a=t.b,o=t.a;i.setClearColor(o*n/255,o*s/255,o*a/255,o)}else i.setClearColor(0,0,0,0);i.setStencilWriteMask(255),i.setClearStencil(0),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,r)}},{key:"dispose",value:function(){var e;if(this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,g.M2)(this._blitRenderer),this._worldExtentClipRenderer=(0,g.M2)(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();var t,r,i=(0,a.Z)(this._fboPool);try{for(i.s();!(t=i.n()).done;){t.value.dispose()}}catch(n){i.e(n)}finally{i.f()}if(this._fboPool.length=0,this.effects)for(r in this.effects)this.effects[r]&&this.effects[r].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=(0,g.M2)(this._vtlMaterialManager),this._prevFBO=null}},{key:"getBrush",value:function(e,t){var r=function(e,t){switch(e){case T.LW.LINE:return B.U.line;case T.LW.TEXT:return B.U.text;case T.LW.LABEL:return B.U.label;case T.LW.FILL:return t===T.mD.DOT_DENSITY?B.U.dotDensity:B.U.fill;case T.LW.MARKER:switch(t){case T.mD.HEATMAP:return B.U.heatmap;case T.mD.PIE_CHART:return B.U.pieChart;default:return B.U.marker}}}(e,t),i=this._brushCache.get(r);return void 0===i&&(i=new r,this._brushCache.set(r,i)),i}},{key:"renderObject",value:function(e,t,r,i){var n=B.U[r];if(n){var s=this._brushCache.get(n);void 0===s&&(s=new n,this._brushCache.set(n,s)),s.prepareState(e,i),s.draw(e,t,i)}}},{key:"renderObjects",value:function(e,t,r,i){var n=B.U[r];if(n){var s=this._brushCache.get(n);void 0===s&&(s=new n,this._brushCache.set(n,s)),s.drawMany(e,t,i)}}},{key:"registerRenderPass",value:function(e){var t=this,r=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new Ye(r,e)}},{key:"blitTexture",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA,W.zi.ONE,W.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,r,i)}},{key:"getPostProcessingEffects",value:function(e){return this._effectsManager.getPostProcessingEffects(e)}},{key:"_getOutputFBO",value:function(){var e,t;return null!=this._renderTarget?this._renderTarget:null!==(e=null===(t=this._fbos)||void 0===t?void 0:t.output)&&void 0!==e?e:null}},{key:"_applyEffects",value:function(e,t){var r,i=null===(r=this._fbos)||void 0===r?void 0:r.blend;if(i){var n,s=e.context,o=this._effectsManager.getPostProcessingEffects(t),u=(0,a.Z)(o);try{for(u.s();!(n=u.n()).done;){var l=n.value,h=l.postProcessingEffect,c=l.effect;s.bindFramebuffer(i),h.draw(e,i,c)}}catch(d){u.e(d)}finally{u.f()}}}}]),e}();function et(e,t,r,i){return e!==T.jx.HIGHLIGHT&&(1!==i||null!=t&&"normal"!==t||null!=r&&r.length>0)}var tt=r(13163),rt=r(84786),it=r(7796),nt=r(42724),st=r(30308),at=r(51e3),ot=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(e,i){var n;(0,o.Z)(this,r),(n=t.call(this))._trash=new Set,n._renderRemainingTime=0,n._lastFrameRenderTime=0,n.renderRequested=!1,n.stage=(0,l.Z)(n),n._stationary=!0;var s=i.canvas,a=void 0===s?document.createElement("canvas"):s,u=i.alpha,h=void 0===u||u,c=i.stencil,d=void 0===c||c,f=i.contextOptions,g=void 0===f?{}:f;n._canvas=a;var b=(0,ne.dz)("2d",a,{alpha:h,antialias:!1,depth:!0,stencil:d});n.context=new nt.x(null!==b&&void 0!==b?b:null,g),n.resourceManager=new y.Z,n.painter=new $e(n.context,(0,l.Z)(n),n.resourceManager),(0,v.Z)("esri-2d-profiler")&&(n._debugOutput=document.createElement("div"),n._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(n._debugOutput));return n._renderParameters={drawPhase:0,state:n.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:n.context,painter:n.painter,timeline:i.timeline||new rt.T,renderingOptions:i.renderingOptions,requestRender:function(){return n.requestRender()},allowDelayedRender:!1,requireFBO:!1,profiler:new tt.Q(n.context,n._debugOutput),dataUploadCounter:0,get highlightGradient(){return n._highlightGradient}},n._taskHandle=(0,m.A)({render:function(e){return n.renderFrame(e)}}),n._taskHandle.pause(),n._lostWebGLContextHandle=(0,p.on)(a,"webglcontextlost",(function(e){n.emit("webgl-error",{error:new _.Z("webgl-context-lost",e.statusMessage)})})),n._bufferPool=new x.Q,a.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(a),n}return(0,u.Z)(r,[{key:"destroy",value:function(){var e,t;this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,g.hw)(this._taskHandle),this._lostWebGLContextHandle=(0,g.hw)(this._lostWebGLContextHandle),null!==(e=this._canvas.parentNode)&&void 0!==e&&e.removeChild(this._canvas),null!==(t=this._debugOutput)&&void 0!==t&&null!==(t=t.parentNode)&&void 0!==t&&t.removeChild(this._debugOutput),this._bufferPool.destroy(),this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}},{key:"trashDisplayObject",value:function(e){this._trash.add(e),this.requestRender()}},{key:"untrashDisplayObject",value:function(e){return this._trash.delete(e)}},{key:"requestRender",value:function(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}},{key:"renderFrame",value:function(e){var t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}},{key:"_createTransforms",value:function(){return{dvs:(0,b.c)()}}},{key:"renderChildren",value:function(e){var t,r=(0,a.Z)(this.children);try{for(r.s();!(t=r.n()).done;){t.value.beforeRender(e)}}catch(s){r.e(s)}finally{r.f()}this._renderChildren(this.children,e);var i,n=(0,a.Z)(this.children);try{for(n.s();!(i=n.n()).done;){i.value.afterRender(e)}}catch(s){n.e(s)}finally{n.f()}}},{key:"_renderChildren",value:function(e,t){var r=this.context;this.painter.textureUploadManager.upload(),r.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=T.jx.MAP,this.painter.beforeRenderLayers(r,this.backgroundColor);var i,n=(0,a.Z)(e);try{for(n.s();!(i=n.n()).done;){i.value.processRender(t)}}catch(d){n.e(d)}finally{n.f()}this.painter.prepareDisplay(t,this.backgroundColor,this.state.padding),this.painter.renderLayers(r),t.drawPhase=T.jx.HIGHLIGHT,this.painter.beforeRenderLayers(r);var s,o=(0,a.Z)(e);try{for(o.s();!(s=o.n()).done;){s.value.processRender(t)}}catch(d){o.e(d)}finally{o.f()}if(this.painter.renderLayers(r),this._isLabelDrawPhaseRequired(e)){t.drawPhase=T.jx.LABEL,this.painter.beforeRenderLayers(r);var u,l=(0,a.Z)(e);try{for(l.s();!(u=l.n()).done;){u.value.processRender(t)}}catch(d){l.e(d)}finally{l.f()}this.painter.renderLayers(r)}if((0,v.Z)("esri-tiles-debug")){t.drawPhase=T.jx.DEBUG,this.painter.beforeRenderLayers(r);var h,c=(0,a.Z)(e);try{for(c.s();!(h=c.n()).done;){h.value.processRender(t)}}catch(d){c.e(d)}finally{c.f()}this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),r.logInfo()}},{key:"doRender",value:function(e){var t=this.context,i=e.state,n=e.pixelRatio;this._resizeCanvas(e),t.setViewport(0,0,n*i.size[0],n*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),(0,h.Z)((0,c.Z)(r.prototype),"doRender",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t){var r,s,a,o,u,l,h,c,d,f,_,p,v,g,m;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Math.round(this.state.size[0]*t.resolutionScale),s=Math.round(this.state.size[1]*t.resolutionScale),a=t.resolutionScale,o=this.context,u=this._state.clone(),null!=t.rotation&&(l=u.viewpoint,u.viewpoint.rotation=t.rotation,u.viewpoint=l),h=(0,n.Z)((0,n.Z)({},this._renderParameters),{},{drawPhase:null,globalOpacity:1,stationary:!0,state:u,pixelRatio:a,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),c=(0,st.Z)(o.gl),(d=new Ee.X(r,s)).wrapMode=W.e8.CLAMP_TO_EDGE,d.internalFormat=c?W.lP.RGBA8:W.VI.RGBA,d.isImmutable=c,f=new Te.X(o,d,new Be.Y(W.Tg.DEPTH_STENCIL,r,s)),_=o.getBoundFramebufferObject(),p=o.getViewport(),o.bindFramebuffer(f),o.setViewport(0,0,r,s),this._renderChildren(t.children,h),v=this._readbackScreenshot(f,(0,n.Z)((0,n.Z)({},t.cropArea),{},{y:s-(t.cropArea.y+t.cropArea.height)})),o.bindFramebuffer(_),o.setViewport(p.x,p.y,p.width,p.height),this.requestRender(),e.next=10,v;case 10:return g=e.sent,e.abrupt("return",(1===t.outputScale?m=g:(m=new ImageData(Math.round(g.width*t.outputScale),Math.round(g.height*t.outputScale)),(0,it.TT)(g,m,!0)),f.dispose(),m));case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_readbackScreenshot",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,at.r)(r.width,r.height,document.createElement("canvas")),e.next=3,t.readPixelsAsync(r.x,r.y,r.width,r.height,W.VI.RGBA,W.Br.UNSIGNED_BYTE,new Uint8Array(n.data.buffer));case 3:return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_resizeCanvas",value:function(e){var t=this._canvas,r=t.style,i=e.state.size,n=e.pixelRatio,s=i[0],a=i[1],o=Math.round(s*n),u=Math.round(a*n);t.width===o&&t.height===u||(t.width=o,t.height=u),r.width=s+"px",r.height=a+"px"}},{key:"_emptyTrash",value:function(){for(;this._trash.size>0;){var e=Array.from(this._trash);this._trash.clear();for(var t=0,r=e;t<r.length;t++){r[t].processDetach()}}}},{key:"_isLabelDrawPhaseRequired",value:function(e){var t,r=!1,i=(0,a.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(!(n instanceof w.W)){r=r||!1;break}if("hasLabels"in n&&n.hasLabels)return!0;r=r||this._isLabelDrawPhaseRequired(n.children)}}catch(s){i.e(s)}finally{i.f()}return r}}]),r}(w.W),ut=r(70812),lt=r(77318),ht=r(75391),ct=r(91908),dt=r(76200),ft=r(14921),_t=r(100),pt=r(16889),vt=r(94172),gt=r(35995),mt=r(87422),bt=r(69610),yt=r(38330);function wt(e){return xt.apply(this,arguments)}function xt(){return xt=(0,s.Z)((0,i.Z)().mark((function e(t){var n,s,a,o,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.e(3581).then(r.bind(r,83581)),s=r.e(8938).then(r.bind(r,78938)),e.t0=yt.t,e.next=5,n;case 5:return e.t1=e.sent.default,e.t2={signal:t},a=(0,e.t0)(e.t1,e.t2),e.t3=yt.t,e.next=11,s;case 11:return e.t4=e.sent.default,e.t5={signal:t},o=(0,e.t3)(e.t4,e.t5),e.next=16,a;case 16:return e.t6=e.sent,e.next=19,o;case 19:return e.t7=e.sent,u={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,re.k_)(t),u));case 22:case"end":return e.stop()}}),e)}))),xt.apply(this,arguments)}var Tt=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.call(this))._handles=new _t.Z,e._resourcePixelRatio=1,e.visible=!1,e}return(0,u.Z)(r,[{key:"destroy",value:function(){this._handles=(0,g.SC)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,g.IM)(this._resourcesTask)}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,vt.YP)((function(){return e.version}),(function(){t.visible=e.visible&&null!=e.position&&e.size>0,t.requestRender()}),vt.nn),(0,vt.YP)((function(){return[e.maskUrl,e.overlayUrl]}),(function(){return t._reloadResources()})),(0,vt.YP)((function(){return e.size}),(function(){t._disposeRenderResources(),t.requestRender()}))])}},{key:"_createTransforms",value:function(){return{dvs:(0,b.c)()}}},{key:"doRender",value:function(e){var t=e.context;if(this._resourcesTask){if(e.drawPhase===T.jx.MAP&&this._canRender()){this._updateResources(e);var r=this._magnifier;if(null!=r.position){var i=e.pixelRatio,n=r.size*i,s=1/r.factor,a=Math.ceil(s*n);this._readbackTexture.resize(a,a);var o=e.state.size,u=i*o[0],l=i*o[1],h=.5*a,c=.5*a,d=(0,pt.uZ)(i*r.position.x,h,u-h-1),f=(0,pt.uZ)(l-i*r.position.y,c,l-c-1);t.setBlendingEnabled(!0);var _=d-h,p=f-c,v=this._readbackTexture;t.bindTexture(v,0),t.gl.copyTexImage2D(v.descriptor.target,0,v.descriptor.pixelFormat,_,p,a,a,0);var g=this.backgroundColor,m=g?[g.a*g.r/255,g.a*g.g/255,g.a*g.b/255,g.a]:[1,1,1,1],b=(d+r.offset.x*i)/u*2-1,y=(f-r.offset.y*i)/l*2-1,w=n/u*2,x=n/l*2,B=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(B),B.setUniform4fv("u_background",m),B.setUniform1i("u_readbackTexture",0),B.setUniform1i("u_overlayTexture",6),B.setUniform1i("u_maskTexture",7),B.setUniform4f("u_drawPos",b,y,w,x),B.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),B.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(W.MX.TRIANGLE_STRIP,0,4),t.bindVAO()}}}else this._reloadResources()}},{key:"_canRender",value:function(){return this.mask&&this.overlay&&null!=this._magnifier}},{key:"_reloadResources",value:function(){var e=this;this._resourcesTask&&this._resourcesTask.abort();var t=null!=this._magnifier?this._magnifier.maskUrl:null,r=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,ft.vr)(function(){var n=(0,s.Z)((0,i.Z)().mark((function n(s){var a,o,u,l,h,c,d;return(0,i.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a=null==t||null==r?wt(s):null,o=null!=t?(0,dt.default)(t,{responseType:"image",signal:s}).then((function(e){return e.data})):a.then((function(e){return e.mask})),u=null!=r?(0,dt.default)(r,{responseType:"image",signal:s}).then((function(e){return e.data})):a.then((function(e){return e.overlay})),i.next=5,Promise.all([o,u]);case 5:l=i.sent,h=(0,Xe.Z)(l,2),c=h[0],d=h[1],e.mask=c,e.overlay=d,e._disposeRenderResources(),e.requestRender();case 10:case"end":return i.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}},{key:"_disposeRenderResources",value:function(){this._readbackTexture=(0,g.M2)(this._readbackTexture),this._overlayTexture=(0,g.M2)(this._overlayTexture),this._maskTexture=(0,g.M2)(this._maskTexture),this._vertexArrayObject=(0,g.M2)(this._vertexArrayObject),this._program=(0,g.M2)(this._program)}},{key:"_updateResources",value:function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),!this._readbackTexture){var t=e.context;this._resourcePixelRatio=e.pixelRatio;var r=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=(0,bt.F)(t);var i=new Uint16Array([0,1,0,0,1,1,1,0]),n=bt.c.attributes;this._vertexArrayObject=new K.U(t,n,H.cD,{geometry:V.f.createVertex(t,W.l1.STATIC_DRAW,i)}),this.overlay.width=r,this.overlay.height=r;var s=new Ee.X;s.internalFormat=W.VI.RGBA,s.wrapMode=W.e8.CLAMP_TO_EDGE,s.samplingMode=W.cw.NEAREST,s.flipped=!0,s.preMultiplyAlpha=!(0,gt.zd)(this.overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new Ie.x(t,s,this.overlay),this.mask.width=r,this.mask.height=r,s.pixelFormat=s.internalFormat=W.VI.ALPHA,this._maskTexture=new Ie.x(t,s,this.mask);var a=1/this._magnifier.factor;s.pixelFormat=s.internalFormat=W.VI.RGBA,s.width=s.height=Math.ceil(a*r),s.samplingMode=W.cw.LINEAR,s.flipped=!1,this._readbackTexture=new Ie.x(t,s)}}}]),r}(mt.s)}}]);
//# sourceMappingURL=8499.7e0fc732.chunk.js.map