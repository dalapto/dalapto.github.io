"use strict";(self.webpackChunkreact=self.webpackChunkreact||[]).push([[3561],{81735:function(e,t,r){r.d(t,{Z:function(){return h}});var n=r(15671),a=r(43144),s=r(60136),i=r(29388),u=r(27366),l=r(41691),o=r(49861),c=(r(25243),r(63780),r(93169),r(69912)),f=function(e){(0,s.Z)(r,e);var t=(0,i.Z)(r);function r(){return(0,n.Z)(this,r),t.apply(this,arguments)}return(0,a.Z)(r,[{key:"initialize",value:function(){}},{key:"destroy",value:function(){}},{key:"supportsTileUpdates",get:function(){return!1}},{key:"spatialReference",get:function(){var e=this.get("tileStore.tileScheme.spatialReference");return e&&e.toJSON()||null}}]),r}(l.r);(0,u._)([(0,o.Cb)({readOnly:!0})],f.prototype,"supportsTileUpdates",null),(0,u._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"remoteClient",void 0),(0,u._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"service",void 0),(0,u._)([(0,o.Cb)()],f.prototype,"spatialReference",null),(0,u._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"tileInfo",void 0),(0,u._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"tileStore",void 0);var h=f=(0,u._)([(0,c.j)("esri.views.2d.layers.features.processors.BaseProcessor")],f)},3561:function(e,t,r){r.r(t),r.d(t,{default:function(){return T}});var n=r(37762),a=r(74165),s=r(15861),i=r(15671),u=r(43144),l=r(60136),o=r(29388),c=r(27366),f=r(75746),h=(r(10064),r(93169),r(32718),r(92026)),d=r(66978),p=(r(25243),r(63780),r(69912)),y=r(48732),v=r(78952),g=r(84328),m=r(80613),_=r(72774),b=r(74017),k=r(61909),x=r(69813),w=r(27301),Z=r(81735),M=r(1413),S=function(){function e(t){(0,i.Z)(this,e),this._remoteClient=t,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}return(0,u.Z)(e,[{key:"destroy",value:function(){}},{key:"fetchResource",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,i,u=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._resourceMap,!(s=n.get(t))){e.next=3;break}return e.abrupt("return",s);case 3:if(!(i=this._inFlightResourceMap.get(t))){e.next=6;break}return e.abrupt("return",i);case 6:e.prev=6,i=this._remoteClient.invoke("tileRenderer.fetchResource",{url:t},(0,M.Z)({},r)),this._inFlightResourceMap.set(t,i),i.then((function(e){return u._inFlightResourceMap.delete(t),n.set(t,e),e})),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(6),e.abrupt("return",(0,d.D_)(e.t0)?null:{width:0,height:0});case 13:return e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this,[[6,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getResource",value:function(e){var t;return null!==(t=this._resourceMap.get(e))&&void 0!==t?t:null}},{key:"loadFont",value:function(e){return Promise.resolve(null)}}]),e}();function I(e,t){return(!e.minScale||e.minScale>=t)&&(!e.maxScale||e.maxScale<=t)}function C(e){var t=e.message,r={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin,version:t.version},transferList:new Array};for(var n in t.data){var a=n,s=t.data[a];if(r.message.data[a]=null,null!=s){var i=s.stride,u=s.indices.slice(0),l=s.vertices.slice(0),o=s.records.slice(0),c={stride:i,indices:u,vertices:l,records:o,metrics:(0,h.yw)(s.metrics,(function(e){return e.slice(0)}))};r.transferList.push(u,l,o),r.message.data[a]=c}}return r}var D=function(e){(0,l.Z)(r,e);var t=(0,o.Z)(r);function r(){var e;return(0,i.Z)(this,r),(e=t.apply(this,arguments)).type="symbol",e._matchers={feature:null,aggregate:null},e._bufferData=new Map,e._bufferIds=new Map,e}return(0,u.Z)(r,[{key:"initialize",value:function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new S(this.remoteClient)}},{key:"destroy",value:function(){this._resourceManagerProxy.destroy()}},{key:"supportsTileUpdates",get:function(){return!0}},{key:"forEachBufferId",value:function(e){this._bufferIds.forEach((function(t){t.forEach(e)}))}},{key:"update",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("symbol"===(s=r.schema.processors[0]).type){e.next=3;break}return e.abrupt("return");case 3:i=(0,y.Hg)(this._schema,s),((0,y.uD)(i,"mesh")||(0,y.uD)(i,"target"))&&(t.mesh=!0,null!==(n=t.why)&&void 0!==n&&n.mesh.push("Symbology changed"),this._schema=s,this._factory=this._createFactory(s),this._factory.update(s,this.tileStore.tileScheme.tileInfo));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"onTileMessage",value:function(e,t,r,n){return(0,d.k_)(n),this._onTileData(e,t,r,n)}},{key:"onTileClear",value:function(e,t){var r={clear:!0,end:t};return this._bufferData.delete(e.key.id),this._bufferIds.delete(e.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:r})}},{key:"onTileError",value:function(e,t,r){var n=r.signal,a={tileKey:e.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",a,{signal:n})}},{key:"onTileUpdate",value:function(e){var t,r=this,a=(0,n.Z)(e.removed);try{for(a.s();!(t=a.n()).done;){var s=t.value;this._bufferData.has(s.key.id)&&this._bufferData.delete(s.key.id),this._bufferIds.has(s.key.id)&&this._bufferIds.delete(s.key.id)}}catch(o){a.e(o)}finally{a.f()}var i,u=(0,n.Z)(e.added);try{var l=function(){var e=i.value;r._bufferData.forEach((function(t){var a,s=(0,n.Z)(t);try{for(s.s();!(a=s.n()).done;){var i=a.value;i.message.tileKey===e.id&&r._updateTileMesh("append",e,C(i),[],!1,!1,null)}}catch(o){s.e(o)}finally{s.f()}}))};for(u.s();!(i=u.n()).done;)l()}catch(o){u.e(o)}finally{u.f()}}},{key:"_addBufferData",value:function(e,t){var r;this._bufferData.has(e)||this._bufferData.set(e,[]),null===(r=this._bufferData.get(e))||void 0===r||r.push(C(t))}},{key:"_createFactory",value:function(e){var t=this,r=this.service,n=r.geometryType,a=r.objectIdField,s={geometryType:n,fields:r.fields,spatialReference:v.Z.fromJSON(this.spatialReference)},i=new k.Wr((function(e,r){return t.remoteClient.invoke("tileRenderer.getMaterialItems",e,r)}),this.tileStore.tileScheme.tileInfo),u=e.mesh,l=u.matcher,o=u.aggregateMatcher;return this._store=i,this._matchers.feature=(0,x.fL)(l,i,s,this._resourceManagerProxy),this._matchers.aggregate=(0,h.yw)(o,(function(e){return(0,x.fL)(e,i,s,t._resourceManagerProxy)})),new b.j(n,a,i)}},{key:"_onTileData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,s,i){var u,l,o,c,f,h,p,y,v,g,m,_,b,k,x,w,Z,M,S,I,C,D,T,R,F=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,d.k_)(i),l=r.type,o=r.addOrUpdate,c=r.remove,f=r.clear,h=r.end,p=!!this._schema.mesh.sortKey,o){e.next=5;break}return y={type:l,addOrUpdate:null,remove:c,clear:f,end:h,sort:p},e.abrupt("return",this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:y},i));case 5:return v=this._processFeatures(t,o,s,i,null===(u=r.status)||void 0===u?void 0:u.version),e.prev=6,e.next=9,v;case 9:if(null!=(g=e.sent)){e.next=13;break}return m={type:l,addOrUpdate:null,remove:c,clear:f,end:h,sort:p},e.abrupt("return",this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:m},i));case 13:_=[],b=(0,n.Z)(g),e.prev=15,b.s();case 17:if((k=b.n()).done){e.next=41;break}if(x=k.value,w=!1,Z=x.message.bufferIds,M=t.key.id,S=x.message.tileKey,M===S||null==Z){e.next=38;break}if(this.tileStore.get(S)){e.next=25;break}return this._addBufferData(M,x),_.push(x),e.abrupt("continue",39);case 25:(I=this._bufferIds.get(S))||(I=new Set,this._bufferIds.set(S,I)),C=Array.from(Z),D=0,T=C;case 29:if(!(D<T.length)){e.next=38;break}if(R=T[D],!I.has(R)){e.next=34;break}return w=!0,e.abrupt("break",38);case 34:I.add(R);case 35:D++,e.next=29;break;case 38:w||(this._addBufferData(M,x),_.push(x));case 39:e.next=17;break;case 41:e.next=46;break;case 43:e.prev=43,e.t0=e.catch(15),b.e(e.t0);case 46:return e.prev=46,b.f(),e.finish(46);case 49:return e.next=51,Promise.all(_.map((function(e){var n=t.key.id===e.message.tileKey,a=n?r.remove:[],s=n&&r.end;return F._updateTileMesh(l,t,e,a,s,!!r.clear,i.signal)})));case 51:e.next=56;break;case 53:e.prev=53,e.t1=e.catch(6),this._handleError(t,e.t1,i);case 56:case"end":return e.stop()}}),e,this,[[6,53],[15,43,46,49]])})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_updateTileMesh",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,s,i,u,l){var o,c,f,p,y;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t,c=n.message.tileKey,f=!!this._schema.mesh.sortKey,c!==r.key.id&&(i=!1),p={type:o,addOrUpdate:(0,h.yw)(n,(function(e){return e.message})),remove:s,clear:u,end:i,sort:f},y={transferList:(0,h.yw)(n,(function(e){return e.transferList}))||[]||0,signal:l},e.abrupt("return",((0,d.k_)(y),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:c,data:p},y)));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,s,i,u){return e.apply(this,arguments)}}()},{key:"_processFeatures",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,s,i){var u,l,o,c,f,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r&&r.hasFeatures){e.next=2;break}return e.abrupt("return",null);case 2:return u={transform:t.transform,hasZ:!1,hasM:!1},l=this._factory,o={viewingMode:"",scale:t.scale},e.next=7,this._matchers.feature;case 7:return c=e.sent,e.next=10,this._matchers.aggregate;case 10:return f=e.sent,(0,d.k_)(s),h=this._getLabelInfos(t,r),e.next=15,l.analyze(r.getCursor(),this._resourceManagerProxy,c,f,u,o);case 15:return(0,d.k_)(s),e.abrupt("return",this._writeFeatureSet(t,r,u,h,l,n,i));case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,s){return e.apply(this,arguments)}}()},{key:"_writeFeatureSet",value:function(e,t,r,n,a,s,i){for(var u=t.getSize(),l=this._schema.mesh.matcher.symbologyType,o=new _._(e.key.id,{features:u,records:u,metrics:0},l,s,l!==m.mD.HEATMAP,i),c={viewingMode:"",scale:e.scale},f=t.getCursor();f.next();)try{var h=f.getDisplayId(),d=null!=n?n.get(h):null;a.writeCursor(o,f,r,c,e.level,d,this._resourceManagerProxy)}catch(y){}var p=e.tileInfoView.tileInfo.isWrappable;return o.serialize(p)}},{key:"_handleError",value:function(e,t,r){if(!(0,d.D_)(t)){var n={tileKey:e.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",n,{signal:r.signal})}return Promise.resolve()}},{key:"_getLabelingSchemaForScale",value:function(e){var t=this._schema.mesh.labels;if(null==t)return null;if("subtype"===t.type){var r={type:"subtype",classes:{}},n=!1;for(var a in t.classes){var s=t.classes[a].filter((function(t){return I(t,e.scale)}));n=n||!!s.length,r.classes[a]=s}return n?r:null}var i=t.classes.filter((function(t){return I(t,e.scale)}));return i.length?{type:"simple",classes:i}:null}},{key:"_getLabels",value:function(e,t){if("subtype"===t.type){var r,n=this.service.subtypeField,a=(0,h.s3)(n,"Expected to find subtype Field"),s=e.readAttribute(a);return null==s?[]:null!==(r=t.classes[s])&&void 0!==r?r:[]}return t.classes}},{key:"_getLabelInfos",value:function(e,t){var r=this,a=this._getLabelingSchemaForScale(e);if(null==a)return null;for(var s=new Map,i=t.getCursor(),u=function(){var e,t=i.getDisplayId(),u=[],l=(0,g.nE)(t),o=l&&1!==i.readAttribute("cluster_count")?"aggregate":"feature",c=r._getLabels(i,a),h=(0,n.Z)(c);try{var d=function(){var n=e.value;if(n.target!==o)return 0;var a=i.getStorage(),s=l&&"feature"===o?a.getComputedStringAtIndex(i.readAttribute("referenceId"),n.fieldIndex):a.getComputedStringAtIndex(t,n.fieldIndex);if(!s)return 0;var c=(0,f.E)(s.toString()),h=c[0],d=c[1];r._store.getMosaicItem(n.symbol,(0,w._)(h)).then((function(e){var t;u[n.index]={glyphs:null!==(t=e.glyphMosaicItems)&&void 0!==t?t:[],rtl:d,index:n.index}}))};for(h.s();!(e=h.n()).done;)d()}catch(p){h.e(p)}finally{h.f()}s.set(t,u)};i.next();)u();return s}}]),r}(Z.Z),T=D=(0,c._)([(0,p.j)("esri.views.2d.layers.features.processors.SymbolProcessor")],D)}}]);
//# sourceMappingURL=3561.977b4741.chunk.js.map